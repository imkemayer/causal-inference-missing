---
title: "Treatment Effect of Tranexamic Acid on TBI patients - Bootstraping"
author: "Imke Mayer"
date: "07/31/2019"
output: 
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache= TRUE)
```


**Same as 2019-07-24_Bootstrap_ATE_TranexamicAcid.Rmd except for adding `Remplissage.total.cristalloides` and `Remplissage.total.colloides` as confounders.**

**We use the following set of confounders in this analysis: `Trauma.Center`, `PAS.min, PAD.min, FC.max`, `Choc.index` (`FC.max`/`PAS.min`), `ACR.1`, `Catecholamines`, `Hemocue.ph`, `Hemoglobine.ph`, `Delta.hemocue`, `Delta.choc.index`, `AIS.externe`, `Remplissage.total.cristalloides` and `Remplissage.total.colloides`.**



# Preliminaries
## Choose population
Estimate ATE on the entire population or only on TBI patients?
```{r }
population <- "tbi"
```

## Load libraries

```{r load_libraries, results='hide'}
suppressPackageStartupMessages(library(cobalt))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(tableone))

suppressPackageStartupMessages(library(caret)) # 
suppressPackageStartupMessages(library(randomForest)) # Random Forests
suppressPackageStartupMessages(library(ranger)) # Random Forests prediction
suppressPackageStartupMessages(library(FactoMineR)) # Factorial data analysis
suppressPackageStartupMessages(library(grf)) # Doubly robust treatment effect estimation

suppressPackageStartupMessages(library(norm))
suppressPackageStartupMessages(library(misaem)) # Logistic regression with missing values
suppressPackageStartupMessages(library(missMDA)) # PCA/MCA with missing values + iterative PC imputation
suppressPackageStartupMessages(library(missForest)) # Random forests with missing values
suppressPackageStartupMessages(library(mice)) # Multiple imputation
suppressPackageStartupMessages(library(naniar)) # Missing values exploration and visualization
suppressPackageStartupMessages(library(VIM)) # Missing values exploration and visualization
suppressPackageStartupMessages(library(BaylorEdPsych)) # Little's MCAR test

suppressPackageStartupMessages(library(RColorBrewer)) # Color scale
myColors <- brewer.pal(6,"Set1")
names(myColors) <- c("-", "FAMD", "MF", "MIA", "MICE", "MEAN")
colScale <- scale_colour_manual(name = "Imputation.method",values = myColors)

suppressPackageStartupMessages(library(kimisc)) # for sample.rows


# Set random generator seed for reproducible results
set.seed(0)

# Define data directory
data.dir <- "~/Documents/TraumaMatrix/CausalInference/AcideTranexamique/Data/"
fig.dir <- "~/Documents/TraumaMatrix/CausalInference/Simulations/causal-inference-missing/TranexamicAcid/Figures/"
helper.dir <- "~/Documents/TraumaMatrix/CausalInference/Simulations/causal-inference-missing/"
source(paste0(helper.dir, "Helper/helper_imputation.R"))
source(paste0(helper.dir, "Helper/helper_causalInference.R"))
source(paste0(helper.dir, "Helper/helper_simulations.R"))
source(paste0(helper.dir, "TranexamicAcid/load.R"))
source(paste0(helper.dir, "Utils/miss.saem.v2.R"))
```

## Load data
Run R markdown `2019-06-06_PrepareDataForATE.Rmd` prior to this to pre-process and save the data for the following analyses.
```{r load_data_for_ate}
data_indAll <- read.csv(paste0(data.dir, "2019-07-31_data_preprocessed_all_individuals.csv"))
if (all(data_indAll[,1]==1:dim(data_indAll)[1])){
  data_indAll <- data_indAll[,-1]
}
data_indTBI <- read.csv(paste0(data.dir, "2019-07-31_data_preprocessed_tbi_individuals.csv"))
if (all(data_indTBI[,1]==1:dim(data_indTBI)[1])){
  data_indTBI <- data_indTBI[,-1]
}
```

```{r unadjusted_ate}
if (population == "tbi"){
   unadjusted_ate <- mean(data_indTBI$DC.Trauma[which(data_indTBI$Acide.tranexamique==max(data_indTBI$Acide.tranexamique))]) - mean(data_indTBI$DC.Trauma[which(data_indTBI$Acide.tranexamique==min(data_indTBI$Acide.tranexamique))])
} else {
   unadjusted_ate <- mean(data_indAll$DC.Trauma[which(data_indAll$Acide.tranexamique==max(data_indAll$Acide.tranexamique))]) - mean(data_indAll$DC.Trauma[which(data_indAll$Acide.tranexamique==min(data_indAll$Acide.tranexamique))])
}
```


# Imputation

We impute the data with different methods (iterative FAMD, mice) and using different subsets of individuals and variables:

i) All individuals (TBI and no-TBI patients)
  a) using all variables
  b) leaving out `Glasgow.sortie`
  
ii) Only TBI patients (not done in this file)
  a) using all variables
  b) leaving out `Glasgow.sortie`
  

Note: Reference for how to handle missing values in the outcome: von Hippel, P. T., Regression with missing Ys: An improved strategy for analyzing multiply imputed data  (2007) https://onlinelibrary.wiley.com/doi/full/10.1111/j.1467-9531.2007.00180.x

## FAMD
For case 1, it is important to go back to the original dataset, instead of focusing just on the patients with trauma cranien and/or AIS.tete >= 2 to compute the missing data. Even though we will only keep the patients with trauma cranien and/or AIS.tete>=2 while running the causal inference analysis, including the other patients at this stage will allow the imputation of missing data to be more informed by adding additional observations for comparison purposes.

Let's look at the matrix plot to identify if there are any variables that tend to be missing together or if we can detect any clear violation of the missing completely at random hypothesis:

```{r }
matrixplot(data_indAll, sortby = 2, las=2, cex.axis = 0.3)
```

The variables that seem to be missing simultaneously are variables sent to the laboratory to be tested, usually simultaneously or as a cohort: `Hb`, `Plaquettes`, `TP.Pourcentage`, `Fibrinogene.1`. However, we do not observe any area predomently red that coincides with others that are particularly dark/light, that would make as suspect the MCAR hypothesis.

We can also run MCA on the missing and non missing entries to double check our conclusion and to check if other groups of variables tend to be missing together:
```{r }
data_miss <- data.frame(is.na(data_indAll))
data_miss <- apply(X=data_miss, FUN=function(x) if(x) "m" else "o", MARGIN=c(1,2))
res.mca <- MCA(data_miss, graph = FALSE)
plot(res.mca, invis = "ind", title = "MCA graph of the categories", cex =0.5)
```



We now perform a single imputation with a (regularized) iterative Factorial Analysis for Mixed Data model, which will allow imputation to take into account similarities between both individuals and relationships between variables. See: https://arxiv.org/pdf/1301.4797.pdf

First we find the optimal number of dimensions for the FAMD by cross-validation
```{r ncomp_all_2outcomes}
# ncomp_all_2outcomes <- estim_ncpFAMD(data_indAll,
# ncp.min = 1,
# ncp.max=20,
# method= "Regularized",
# method.cv = "Kfold",
# nbsim=10,
# verbose = TRUE)
# 
# save(ncomp_all_2outcomes,
#      data_indAll,
#      file = paste0(data.dir, Sys.Date(),"_ncomp_all_2outcomes.RData"))
```

```{r plot_ncomp_all_2outcomes}
load(paste0(data.dir, "2019-07-31","_ncomp_all_2outcomes.RData"))
plot(1:length(ncomp_all_2outcomes$criterion), ncomp_all_2outcomes$criterion, xlab = "nb dim", ylab = "MSEP")
```

By cross-validation we find ncp=11 to be the optimal number of components.

```{r famd_impute_all_2outcomes}
# ncp = 11
# imputed_all_2outcomes_FAMD <- get_FAMD(data_indAll, seed = 0, ncp=ncp, Method = "Regularized", scale = T, threshold = 1e-06)
# 
# res.famd <- FAMD(imputed_all_2outcomes_FAMD,
#                  ncp = ncp, graph=F)
# 
# if (population == "tbi"){
# # After imputation, restrain to the target units (TBI patients)
#   imputed_all_2outcomes_FAMD <- imputed_all_2outcomes_FAMD[imputed_all_2outcomes_FAMD$Trauma.cranien %in% c("1") | imputed_all_2outcomes_FAMD$AIS.tete >= 2, ]
# }
```


Again we find the optimal number of dimensions for the FAMD by cross-validation, this time we leave out the outcome `Glasgow.sortie`.
```{r ncomp_all_1outcome}
# ncomp_all_1outcome <- estim_ncpFAMD(data_indAll[, !(names(data_indAll) == "Glasgow.sortie")],
#                        ncp.min = 1,
#                        ncp.max=20,
#                        method= "Regularized",
#                        method.cv = "Kfold",
#                        nbsim=10,
#                        verbose = TRUE)
# 
# save(ncomp_all_1outcome,
#      file = paste0(data.dir, Sys.Date(),"_ncomp_all_1outcome.RData"))
```

```{r plot_ncomp_all_1outcome }
load(paste0(data.dir, "2019-07-31","_ncomp_all_1outcome.RData"))
plot(1:length(ncomp_all_1outcome$criterion), ncomp_all_1outcome$criterion, xlab = "nb dim", ylab = "MSEP")
```

By cross-validation we find ncp=11 to be the optimal number of components.

```{r famd_impute_all_1outcome}
# ncp = 11
# imputed_all_1outcome_FAMD <- get_FAMD(data_indAll[, !(names(data_indAll) == "Glasgow.sortie")], seed = 0, ncp=ncp, Method = "Regularized", scale = T, threshold = 1e-06)
# 
# if (population == "tbi"){
# # After imputation, restrain to the target units (TBI patients)
#   imputed_all_1outcome_FAMD <- imputed_all_1outcome_FAMD[imputed_all_1outcome_FAMD$Trauma.cranien %in% c("1") | imputed_all_1outcome_FAMD$AIS.tete >= 2, ]
# }
```


## Latent confounders (Kallus, Mao and Udell, 2018)
We perform FAMD on the pre-treatment covariates, i.e. we put aside the treatment and outcome variables (which are fully observed in this case).

```{r select_pretreatment-confounders}
confounders <- c("Trauma.Center", "PAS.min", "PAD.min", "FC.max", 
                 "ACR.1", "Catecholamines",
                 "AIS.externe", "Hemocue.init", "Delta.hemocue",
                 "Shock.index.ph", "Delta.shock.index", "Remplissage.total.cristalloides", "Remplissage.total.colloides")
```


First we find the optimal number of dimensions for the FAMD by cross-validation
```{r ncomp_all_mf}
# ncomp <- estim_ncpFAMD(data_indAll[,names(data_indAll) %in% confounders],
#                        ncp.min = 1,
#                        ncp.max=10,
#                        method= "Regularized",
#                        method.cv = "Kfold",
#                        nbsim=10,
#                        verbose = TRUE)
#  
# save(ncomp_all_confounders,
#      file = paste0(data.dir, Sys.Date(),"_ncomp_all_confounders.RData"))
```

```{r plot_ncomp_all_mf}
load(paste0(data.dir, "2019-07-31","_ncomp_all_confounders.RData"))
plot(1:10, ncomp_all_confounders$criterion, xlab = "nb dim", ylab = "MSEP")
```

The criterion is minimized for ncp = 3.

Then we find the principal dimensions of FAMD
```{r famd_impute_all_mf}
# ncp = 3
# imputed_covariates <- get_FAMD(data_indAll[,names(data_indAll) %in% confounders], 
#                                seed = 0, ncp=ncp, Method = "Regularized", scale = T, threshold = 1e-06)
# 
# 
# res.famd <- FAMD(imputed_covariates,
#                  ncp = ncp, graph=F)
# 
# confounders_all_MF <- res.famd$ind$coord
# 
# if (population == "tbi"){
# # After factorization, restrain to the target units (TBI patients)
#   row_num <- which(data_indAll$Trauma.cranien %in% c("1") | data_indAll$AIS.tete >= 2)
#   confounders_all_MF <- confounders_all_MF[row_num,]
# }
```

## MICE

```{r mice_impute_all_2outcomes}
# imputed_all_2outcomes_mice <- get_MICE(data_indAll, seed = 0, m=5)
# 
# if (population == "tbi"){
# # After imputation, restrain to the target units (TBI patients)
#   for (k in 1:5){
#     imputed_all_2outcomes_mice[[k]] <- imputed_all_2outcomes_mice[[k]][imputed_all_2outcomes_mice[[k]]$Trauma.cranien %in% c("1") | imputed_all_2outcomes_mice[[k]]$AIS.tete >= 2, ]
#   }
# }
```


```{r mice_impute_all_1outcome}
# imputed_all_1outcome_mice <- get_MICE(data_indAll[, !(names(data_indAll) == "Glasgow.sortie")], seed = 0, m=5)
# 
# if (population == "tbi"){
# # After imputation, restrain to the target units (TBI patients)
#   for (k in 1:5){
#     imputed_all_1outcome_mice[[k]] <- imputed_all_1outcome_mice[[k]][imputed_all_1outcome_mice[[k]]$Trauma.cranien %in% c("1") | imputed_all_1outcome_mice[[k]]$AIS.tete >= 2, ]
#   }
# }
```


# Add variance estimation via bootstrap


```{r sampling}

# Sample a random set of n obserservations from the dataset df (having n observations) with replacement
get_sample <- function(df, seed) {
  set.seed(seed)
  sample <- dplyr::sample_n(df, nrow(df), replace=T)
  return(sample)
}

get_imputed_sample <- function(df, seed, imputation, ncp,
                               population = "tbi"){
  factors <- NULL
  sample <- get_sample(df,seed)
  #sample$outcome <- as.factor(as.integer(sample$outcome))
  #levels(sample$outcome) <- c(0,1)
  
  # sample <- sample[,!colnames(sample) %in% c("outcome","treatment")]
      
  # Imputation
  if (imputation == "FAMD") {
    imputed <- get_FAMD(sample, seed = seed, ncp=ncp)
    if (population == "tbi"){
      imputed <- imputed[imputed$Trauma.cranien %in% c("1") | imputed$AIS.tete >= 2, ]
      sample <- sample[sample$Trauma.cranien %in% c("1") | sample$AIS.tete >= 2, ]
    }
    
  } else if (imputation == "MICE") {
    imputed <- get_MICE(sample, seed = seed, m = 5)
    if (population == "tbi"){
      for (k in 1:length(imputed)){
        imputed[[k]] <- imputed[[k]][imputed[[k]]$Trauma.cranien %in% c("1") | imputed[[k]]$AIS.tete >= 2, ]
      }
      sample <- sample[sample$Trauma.cranien %in% c("1") | sample$AIS.tete >= 2, ]
    }
  } else if (imputation == "MIA") {
    imputed <- get_imputeInf(sample)
    if (population == "tbi"){
      imputed <- imputed[imputed$Trauma.cranien %in% c("1") | imputed$AIS.tete >= 2, ]
      sample <- sample[sample$Trauma.cranien %in% c("1") | sample$AIS.tete >= 2, ]
    }
  } else if (imputation == "MF") {
    imputed <- get_FAMD(sample[,confounders], seed = seed, ncp=ncp)
    res.famd <- FAMD(imputed,
                     ncp = ncp, graph=F)
    factors <- res.famd$ind$coord
    
    imputed <- get_FAMD(sample, seed = seed, ncp=ncp)
    if (population == "tbi"){
      row_num <- which(sample$Trauma.cranien %in% c("1") | sample$AIS.tete >= 2)
      factors <- factors[row_num,]
      imputed <- imputed[row_num,]
      sample <- sample[row_num, ]
    }
    
  }
  return(list("imputed" = imputed, "miss" = sample, "factors" = factors))
}
```


```{r functions_bootstrap_variance_estimation, warning=F}
get_bootstrap <- function(N, data, imputation="FAMD", use.mask= FALSE, ncp = NULL, population=population){
  res.ipw <- c()
  res.dr <- c()
  for (seed in 1:N){
    if (seed == N) writeLines(paste0("\nLast sampling ", seed))
    try({
      #writeLines("\n\t Impute")
      sample <- get_imputed_sample(data, seed, imputation, ncp = ncp, population)
   
      if (tolower(imputation)=="mice"){
        df <- list()
        df.confounders <- list()
        mask.confounders <- NULL
        mask <- NULL
        if (use.mask) mask.confounders <- mask <- list()
        for (k in 1:length(sample$imputed)){
          df[[k]] <- sample$imputed[[k]] %>% 
                      dplyr::select(-c("Acide.tranexamique", "DC.Trauma"))
      
          if ("Glasgow.sortie" %in% colnames(df[[k]])) {
            df[[k]] <- df[[k]] %>%
                  dplyr::select(-"Glasgow.sortie")
          }
      
          df.confounders[[k]] <- df[[k]] %>% dplyr::select(confounders)
      
          if (use.mask){
            mask.confounders[[k]] <- is.na(sample$miss[,colnames(df.confounders[[k]])])
            mask.confounders[[k]] <- data.frame(mask.confounders[[k]][,sapply(data.frame(mask.confounders[[k]]), FUN = function(x) length(unique(x))==2)])
            mask[[k]] <- is.na(sample$miss[,colnames(df[[k]])])
            mask[[k]] <- data.frame(mask[[k]][,sapply(data.frame(mask[[k]]), FUN = function(x) length(unique(x))==2)])
          }
        }
        treatment <- as.numeric(sample$imputed[[1]]$Acide.tranexamique)
        outcome <- as.numeric(sample$imputed[[1]]$DC.Trauma)
      } else if (tolower(imputation) != "mf"){    
        df <- sample$imputed %>% 
                dplyr::select(-c("Acide.tranexamique", "DC.Trauma"))
        
        if ("Glasgow.sortie" %in% colnames(df)) {
          df <- df %>%
                dplyr::select(-"Glasgow.sortie")
        }
        if (tolower(imputation) != "mia"){
          df.confounders <- df %>% dplyr::select(confounders)
        } else {
          df.confounders <- get_imputeInf(sample$miss[, confounders])
        }
        
        mask.confounders <- NULL
        mask <- NULL
        if (use.mask){
          mask.confounders <- is.na(sample$miss[,colnames(df.confounders[,1:length(confounders)])])
          mask.confounders <- data.frame(mask.confounders[,sapply(data.frame(mask.confounders), FUN = function(x) length(unique(x))==2)])
          mask <- is.na(sample$miss[,intersect(colnames(df), colnames(sample$miss))])
          mask <- data.frame(mask[,sapply(data.frame(mask), FUN = function(x) length(unique(x))==2)])
        }
        
        treatment <- as.numeric(sample$imputed$Acide.tranexamique)
        outcome <- as.numeric(sample$imputed$DC.Trauma)
      } else {
        # MF case
        treatment <- sample$imputed$Acide.tranexamique
        outcome <- sample$imputed$DC.Trauma

        df.confounders <- data.frame(sample$factors)
        df <- cbind(df.confounders, dplyr::select(data.frame(sample$imputed), -c(confounders, "Acide.tranexamique", "DC.Trauma", "Glasgow.sortie")))
        mask.confounders <- NULL
        mask <- NULL
 
      }
      
      #writeLines("\n\t IPW ATE estimation with PS by logistic regression")
      for (method in c("glm","grf")){
        if (tolower(imputation) == "mia" & method == "glm"){
          next
        }
        if (tolower(imputation)== "mice"){
          tmp <- c()
          for (k in 1:length(sample$imputed)){
            tmp <- rbind(tmp, ipw(X=df.confounders[[k]], outcome = outcome, treat = treatment,
                                  mask = mask.confounders[[k]],
                                  ps.method = method, target = "all", 
                                  seed=0, trimming_weight=.999))
          }
          res.tmp <- apply(tmp, 2, mean)
          res.tmp[3] <- res.tmp[3] + (1+ 1/5)*sum((tmp[,2] - res.tmp[2])^2)/4
          res.tmp <- t(res.tmp)
        } else {
          res.tmp <- ipw(X=df.confounders, outcome = outcome, treat = treatment,
                         mask = mask.confounders,
                         ps.method = method, target = "all", 
                         seed=0, trimming_weight=.999)
        }
        res.ipw <- rbind(res.ipw, cbind(data.frame(res.tmp), tolower(imputation), method, as.integer(seed)))
      }
      
      for (method in c("glm", "grf.ate")){
        if (tolower(imputation) == "mia" & method == "glm"){
          next
        }
        if (tolower(imputation) == "mice"){
          tmp <- c()
          for (k in 1:length(sample$imputed)){
            tmp <- rbind(tmp, dr(X=df.confounders[[k]],
                                 outcome = outcome, treat = treatment,
                                 mask = mask.confounders[[k]],
                                 mask.for.outcome = mask[[k]],
                                 X.for.outcome = df[[k]],
                                 ps.method = method, out.method = method,
                                 target = "all", 
                                 seed=0, trimming_weight=.999)) 
          }
          res.tmp <- apply(tmp, 2, mean)
          res.tmp[2] <- res.tmp[2] + (1+ 1/5)*sum((tmp[,1] - res.tmp[1])^2)/4
          res.tmp <- t(res.tmp)
        } else {
          res.tmp <- dr(X=df.confounders, outcome = outcome, treat = treatment,
                        mask = mask.confounders,
                        mask.for.outcome = mask,
                        X.for.outcome = df,
                        ps.method = method, out.method = method,
                        target = "all", 
                        seed=0, trimming_weight=.999)
        }
        res.dr <- rbind(res.dr, cbind(data.frame(res.tmp), tolower(imputation), method, as.integer(seed)))
      }
    })
  }
  return(list("ipw" = res.ipw, "dr" = res.dr))
}
```

## FAMD
Imputation on all individuals and all variables
```{r compute_bootstrap_famd_wMask, warning=F}
N <- 50
res.famd.bs <- NULL
if (N>0){
res.famd.bs <- get_bootstrap(N,data_indAll,
                             imputation="FAMD", ncp=11,
                             use.mask = TRUE,
                             population = population)
}

```

## MICE
Imputation on all individuals and all variables
```{r compute_bootstrap_mice_wMask, warning=F}
N <- 50
res.mice.bs <- NULL
if (N>0){
res.mice.bs <- get_bootstrap(N,data_indAll,
                             imputation="MICE",
                             use.mask = TRUE,
                             population = population)
}
```

## MIA
Imputation on all individuals and all variables
```{r compute_bootstrap_mia_wMask, warning=F}
N <- 50
res.mia.bs <- NULL
if (N>0){
res.mia.bs <- get_bootstrap(N,data_indAll[, which(colnames(data_indAll) != "Glasgow.sortie")],
                             imputation="MIA", 
                             use.mask = TRUE,
                             population = population)
}

```

## MF
Imputation on all individuals and all variables
```{r compute_bootstrap_mf_woMask, warning=F}
N <- 50
res.mf.bs <- NULL
if (N>0){
res.mf.bs <- get_bootstrap(N,data_indAll,
                           imputation="MF", ncp = 3,
                           use.mask = FALSE,
                           population = population)

}


```

# Bootstrap results
```{r use_bootstrap_results_famd, echo=F}
if (N>0){
writeLines("IPW on FAMD imputed data (imputation on all observations and all variables)\n")
writeLines(paste0("\t CI for ATE when estimating PS with logistic regression: [", 
                  round(quantile(res.famd.bs$ipw[which(res.famd.bs$ipw$method == "glm"),2], 0.025),digits=3), ", ",
                  round(quantile(res.famd.bs$ipw[which(res.famd.bs$ipw$method == "glm"),2], 0.975),digits=3), "]\n"))

writeLines(paste0("\t CI for ATE when estimating PS with grf: [", 
                  round(quantile(res.famd.bs$ipw[which(res.famd.bs$ipw$method == "grf"),2], 0.025),digits=3), ", ",
                  round(quantile(res.famd.bs$ipw[which(res.famd.bs$ipw$method == "grf"),2], 0.975),digits=3), "]\n"))
           

writeLines("DR on FAMD imputed data (imputation on all observations and all variables)\n")

writeLines(paste0("\t CI for ATE when estimating PS with logistic regression: [", 
                  round(quantile(res.famd.bs$dr[which(res.famd.bs$dr$method == "glm"),1], 0.025),digits=3), ", ",
                  round(quantile(res.famd.bs$dr[which(res.famd.bs$dr$method == "glm"),1], 0.975),digits=3), "]\n"))
           
writeLines(paste0("\t CI for ATE when estimating PS with grf: [", 
                  round(quantile(res.famd.bs$dr[which(res.famd.bs$dr$method == "grf.ate"),1], 0.025),digits=3), ", ",
                  round(quantile(res.famd.bs$dr[which(res.famd.bs$dr$method == "grf.ate"),1], 0.975),digits=3), "]\n"))

}
```

```{r use_bootstrap_results_mice, echo=F}
if (N>0){
writeLines("IPW on MICE imputed data (imputation on all observations and all variables)\n")
writeLines(paste0("\t CI for ATE when estimating PS with logistic regression: [", 
                  round(quantile(res.mice.bs$ipw[which(res.mice.bs$ipw$method == "glm"),2], 0.025),digits=3), ", ",
                  round(quantile(res.mice.bs$ipw[which(res.mice.bs$ipw$method == "glm"),2], 0.975),digits=3), "]\n"))

writeLines(paste0("\t CI for ATE when estimating PS with grf: [", 
                  round(quantile(res.mice.bs$ipw[which(res.mice.bs$ipw$method == "grf"),2], 0.025),digits=3), ", ",
                  round(quantile(res.mice.bs$ipw[which(res.mice.bs$ipw$method == "grf"),2], 0.975),digits=3), "]\n"))
           

writeLines("DR on MICE imputed data (imputation on all observations and all variables)\n")

writeLines(paste0("\t CI for ATE when estimating PS with logistic regression: [", 
                  round(quantile(res.mice.bs$dr[which(res.mice.bs$dr$method == "glm"),1], 0.025),digits=3), ", ",
                  round(quantile(res.mice.bs$dr[which(res.mice.bs$dr$method == "glm"),1], 0.975),digits=3), "]\n"))
           
writeLines(paste0("\t CI for ATE when estimating PS with grf: [", 
                  round(quantile(res.mice.bs$dr[which(res.mice.bs$dr$method == "grf.ate"),1], 0.025),digits=3), ", ",
                  round(quantile(res.mice.bs$dr[which(res.mice.bs$dr$method == "grf.ate"),1], 0.975),digits=3), "]\n"))
}
```

```{r use_bootstrap_results_mia, echo=F}
if (N>0){
writeLines("IPW on MIA imputed data\n")

writeLines(paste0("\t CI for ATE when estimating PS with grf: [", 
                  round(quantile(res.mia.bs$ipw[which(res.mia.bs$ipw$method == "grf"),2], 0.025),digits=3), ", ",
                  round(quantile(res.mia.bs$ipw[which(res.mia.bs$ipw$method == "grf"),2], 0.975),digits=3), "]\n"))
           

writeLines("DR on MIA imputed data (imputation on all observations and all variables)\n")

writeLines(paste0("\t CI for ATE when estimating PS with grf: [", 
                  round(quantile(res.mia.bs$dr[which(res.mia.bs$dr$method == "grf.ate"),1], 0.025),digits=3), ", ",
                  round(quantile(res.mia.bs$dr[which(res.mia.bs$dr$method == "grf.ate"),1], 0.975),digits=3), "]\n"))

}
```

```{r use_bootstrap_results_mf, echo=F}
if (N>0){
writeLines("IPW on matrix factorization data\n")

writeLines(paste0("\t CI for ATE when estimating PS with grf: [", 
                  round(quantile(res.mf.bs$ipw[which(res.mf.bs$ipw$method == "grf"),2], 0.025),digits=3), ", ",
                  round(quantile(res.mf.bs$ipw[which(res.mf.bs$ipw$method == "grf"),2], 0.975),digits=3), "]\n"))
           

writeLines("DR on MIA imputed data (imputation on all observations and all variables)\n")

writeLines(paste0("\t CI for ATE when estimating PS with grf: [", 
                  round(quantile(res.mf.bs$dr[which(res.mf.bs$dr$method == "grf.ate"),1], 0.025),digits=3), ", ",
                  round(quantile(res.mf.bs$dr[which(res.mf.bs$dr$method == "grf.ate"),1], 0.975),digits=3), "]\n"))
}
```

```{r save_bootstrap_results}
bs.ipw <- rbind(res.famd.bs$ipw,
                res.mice.bs$ipw,
                res.mia.bs$ipw,
                res.mf.bs$ipw)
bs.dr <- rbind(res.famd.bs$dr,
               res.mice.bs$dr,
               res.mia.bs$dr,
               res.mf.bs$dr)


save(bs.ipw, bs.dr, file = paste0("~/Documents/TraumaMatrix/CausalInference/Simulations/causal-inference-missing/TranexamicAcid/RData/",Sys.Date(),"_bootstrap4_ate_",population,"patients.RData"))
```

```{r bootstrap_distributions_ipw_glm}
bs.ipw.glm <- bs.ipw[which(bs.ipw$method == "glm"),]
plot.ipw.glm <- NULL
if (N>0){
  ipw_ate_all <- bs.ipw.glm[1,]
plot.ipw.glm <- ggplot(data=data.frame(bs.ipw.glm)) + 
  geom_histogram(aes(x = ipw2, y=..density..), colour="black", fill="white") + 
  geom_vline(aes(xintercept=mean(ipw2)),
            color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(ipw2,0.025)),
            color="blue", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(ipw2,0.975)),
            color="blue", linetype="dashed", size=1) + 
  # geom_errorbarh(data = ipw_ate_all, 
  #                aes(xmax = ATE.p100/100 + 1.96*STD.p100/100, 
  #                    xmin = ATE.p100/100 - 1.96*STD.p100/100,
  #                    y=0.1),
  #                    height = 6,
  #                    size = 2) +
  theme(axis.text=element_text(size=15)) +
  facet_grid(~as.factor(tolower.imputation.)) +
  labs(title="IPW ATE with PS via logistic regression", cex=0.8)
}
plot.ipw.glm

```

```{r bootstrap_distributions_ipw_grf}
bs.ipw.grf <- bs.ipw[which(bs.ipw$method == "grf"),]
plot.ipw.grf <- NULL
if (N>0){
  ipw_ate_all <- bs.ipw.grf[1,]
plot.ipw.grf <- ggplot(data=data.frame(bs.ipw.grf)) + 
  geom_histogram(aes(x = ipw2, y=..density..), colour="black", fill="white") + 
  geom_vline(aes(xintercept=mean(ipw2)),
            color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(ipw2,0.025)),
            color="blue", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(ipw2,0.975)),
            color="blue", linetype="dashed", size=1) + 
  # geom_errorbarh(data = ipw_ate_all, 
  #                aes(xmax = ATE.p100/100 + 1.96*STD.p100/100, 
  #                    xmin = ATE.p100/100 - 1.96*STD.p100/100,
  #                    y=0.1),
  #                    height = 6,
  #                    size = 2) +
  theme(axis.text=element_text(size=15)) +
  facet_grid(~as.factor(tolower.imputation.)) +
  labs(title="IPW ATE with PS via GRF", cex=0.8)
}

plot.ipw.grf

```


```{r bootstrap_distributions_dr_glm}
bs.dr.glm <- bs.dr[which(bs.dr$method == "glm"),]
plot.dr.glm <- NULL
if (N>0){
  dr_ate_all <- bs.dr.glm[1,]
plot.dr.glm <- ggplot(data=data.frame(bs.dr.glm)) + 
  geom_histogram(aes(x = dr, y=..density..), colour="black", fill="white") + 
  geom_vline(aes(xintercept=mean(dr)),
            color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(dr,0.025)),
            color="blue", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(dr,0.975)),
            color="blue", linetype="dashed", size=1) + 
  # geom_errorbarh(data = dr_ate_all, 
  #                aes(xmax = ATE.p100/100 + 1.96*STD.p100/100, 
  #                    xmin = ATE.p100/100 - 1.96*STD.p100/100,
  #                    y=0.1),
  #                    height = 6,
  #                    size = 2) +
  theme(axis.text=element_text(size=15)) +
  facet_wrap(~as.factor(tolower.imputation.)) +
  labs(title="DR ATE with PS via GRF", cex=0.8)
}
plot.dr.glm

```

```{r bootstrap_distributions_dr_grf}
bs.dr.grf <- bs.dr[which(bs.dr$method == "grf.ate"),]
plot.dr.grf <- NULL
if (N>0){
  dr_ate_all <- bs.dr.grf[1,]
plot.dr.grf <- ggplot(data=data.frame(bs.dr.grf)) + 
  geom_histogram(aes(x = dr, y=..density..), colour="black", fill="white") + 
  geom_vline(aes(xintercept=mean(dr)),
            color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(dr,0.025)),
            color="blue", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(dr,0.975)),
            color="blue", linetype="dashed", size=1) + 
  # geom_errorbarh(data = dr_ate_all, 
  #                aes(xmax = ATE.p100/100 + 1.96*STD.p100/100, 
  #                    xmin = ATE.p100/100 - 1.96*STD.p100/100,
  #                    y=0.1),
  #                    height = 6,
  #                    size = 2) +
  theme(axis.text=element_text(size=15)) +
  facet_wrap(.~as.factor(tolower.imputation.)) +
  labs(title="DR ATE with PS via GRF", cex=0.8)
}
plot.dr.grf

```






