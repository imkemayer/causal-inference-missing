---
title: "Treatment Effect of Tranexamic Acid on TBI patients"
author: "Imke Mayer"
date: "14/06/2019"
output: 
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache= TRUE)
```


**We use the following set of confounders in this analysis: `Trauma.Center`, `PAS.min, PAD.min, FC.max`, `Choc.index` (`FC.max`/`PAS.min`), `ACR.1`, `Catecholamines`, `Hemocue.ph`, `Hemoglobine.ph`, `Delta.hemocue`, `Delta.choc.index`, `AIS.externe`.**


**For the double robust estimator, we use additional covariates for the outcome regression ($Y\sim X$), more specifically we use the above confounders and other pre- and post-treatment covariates that have not been identified as confounders.**


# Preliminaries
## Choose population
Estimate ATE on the entire population or only on TBI patients?
```{r }
population <- "all" # "tbi"
```

## Load libraries

```{r load_libraries, results='hide'}

suppressPackageStartupMessages(library(cobalt))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(tableone))

suppressPackageStartupMessages(library(caret)) # 
suppressPackageStartupMessages(library(randomForest)) # Random Forests
suppressPackageStartupMessages(library(ranger)) # Random Forests prediction
suppressPackageStartupMessages(library(FactoMineR)) # Factorial data analysis
suppressPackageStartupMessages(library(grf)) # Doubly robust treatment effect estimation

suppressPackageStartupMessages(library(misaem)) # Logistic regression with missing values
suppressPackageStartupMessages(library(missMDA)) # PCA/MCA with missing values + iterative PC imputation
suppressPackageStartupMessages(library(missForest)) # Random forests with missing values
suppressPackageStartupMessages(library(mice)) # Multiple imputation
suppressPackageStartupMessages(library(naniar)) # Missing values exploration and visualization
suppressPackageStartupMessages(library(VIM)) # Missing values exploration and visualization
suppressPackageStartupMessages(library(BaylorEdPsych)) # Little's MCAR test

suppressPackageStartupMessages(library(RColorBrewer)) # Color scale
myColors <- brewer.pal(6,"Set1")
names(myColors) <- c("-", "FAMD", "MF", "MIA", "MICE", "MEAN")
colScale <- scale_colour_manual(name = "Imputation.method",values = myColors)


# Set random generator seed for reproducible results
set.seed(0)

# Define data directory
data.dir <- "~/Documents/TraumaMatrix/CausalInference/AcideTranexamique/Data/"
fig.dir <- "~/Documents/TraumaMatrix/CausalInference/AcideTranexamique/Figures/"
helper.dir <- "~/Documents/TraumaMatrix/CausalInference/Simulations/causal-inference-missing/"
source(paste0(helper.dir, "Helper/helper_imputation.R"))
source(paste0(helper.dir, "Helper/helper_causalInference.R"))
source(paste0(helper.dir, "Helper/helper_simulations.R"))
source(paste0(helper.dir, "TranexamicAcid/load.R"))
source(paste0(helper.dir, "Utils/miss.saem.v2.R"))
```

## Load data
Run R markdown `2019-06-06_PrepareDataForATE.Rmd` prior to this to pre-process and save the data for the following analyses.
```{r load_data_for_ate}
data_indAll <- read.csv(paste0(data.dir, "data_preprocessed_all_individuals.csv"))
data_indTBI <- read.csv(paste0(data.dir, "data_preprocessed_tbi_individuals.csv"))
```

# Imputation

We impute the data with different methods (iterative FAMD, mice) and using different subsets of individuals and variables:

i) All individuals (TBI and no-TBI patients)
  a) using all variables
  b) leaving out `Glasgow.sortie`
  
ii) Only TBI patients (not done in this file)
  a) using all variables
  b) leaving out `Glasgow.sortie`
  

Note: Reference for how to handle missing values in the outcome: von Hippel, P. T., Regression with missing Ys: An improved strategy for analyzing multiply imputed data  (2007) https://onlinelibrary.wiley.com/doi/full/10.1111/j.1467-9531.2007.00180.x

## FAMD
For case 1, it is important to go back to the original dataset, instead of focusing just on the patients with trauma cranien and/or AIS.tete >= 2 to compute the missing data. Even though we will only keep the patients with trauma cranien and/or AIS.tete>=2 while running the causal inference analysis, including the other patients at this stage will allow the imputation of missing data to be more informed by adding additional observations for comparison purposes.

Let's look at the matrix plot to identify if there are any variables that tend to be missing together or if we can detect any clear violation of the missing completely at random hypothesis:

```{r }
matrixplot(data_indAll, sortby = 2, las=2, cex.axis = 0.3)
```

The variables that seem to be missing simultaneously are variables sent to the laboratory to be tested, usually simultaneously or as a cohort: `Hb`, `Plaquettes`, `TP.Pourcentage`, `Fibrinogene.1`. However, we do not observe any area predomently red that coincides with others that are particularly dark/light, that would make as suspect the MCAR hypothesis.

We can also run MCA on the missing and non missing entries to double check our conclusion and to check if other groups of variables tend to be missing together:
```{r }
data_miss <- data.frame(is.na(data_indAll))
data_miss <- apply(X=data_miss, FUN=function(x) if(x) "m" else "o", MARGIN=c(1,2))
res.mca <- MCA(data_miss, graph = FALSE)
plot(res.mca, invis = "ind", title = "MCA graph of the categories", cex =0.5)
```



We now perform a single imputation with a (regularized) iterative Factorial Analysis for Mixed Data model, which will allow imputation to take into account similarities between both individuals and relationships between variables. See: https://arxiv.org/pdf/1301.4797.pdf

First we find the optimal number of dimensions for the FAMD by cross-validation
```{r ncomp_all_2outcomes}
# ncomp_all_2outcomes <- estim_ncpFAMD(data_indAll,
# ncp.min = 1,
# ncp.max=20,
# method= "Regularized",
# method.cv = "Kfold",
# nbsim=10,
# verbose = TRUE)
# 
# save(ncomp_all_2outcomes,
#      data_indAll,
#      file = paste0(data.dir, Sys.Date(),"_ncomp_all_2outcomes.RData"))
```

```{r plot_ncomp_all_2outcomes}
load(paste0(data.dir, "2019-06-14","_ncomp_all_2outcomes.RData"))
plot(1:length(ncomp_all_2outcomes$criterion), ncomp_all_2outcomes$criterion, xlab = "nb dim", ylab = "MSEP")
```

By cross-validation we find ncp=18 to be the optimal number of components.

```{r famd_impute_all_2outcomes}
ncp = 18
imputed_all_2outcomes_FAMD <- get_FAMD(data_indAll, seed = 0, ncp=ncp, Method = "Regularized", scale = T, threshold = 1e-06)

res.famd <- FAMD(imputed_all_2outcomes_FAMD,
                 ncp = ncp, graph=F)

if (population == "tbi"){
# After imputation, restrain to the target units (TBI patients)
  imputed_all_2outcomes_FAMD <- imputed_all_2outcomes_FAMD[imputed_all_2outcomes_FAMD$Trauma.cranien %in% c("1") | imputed_all_2outcomes_FAMD$AIS.tete >= 2, ]
}
```


Again we find the optimal number of dimensions for the FAMD by cross-validation, this time we leave out the outcome `Glasgow.sortie`.
```{r ncomp_all_1outcome}
# ncomp_all_1outcome <- estim_ncpFAMD(data_indAll[, !(names(data_indAll) == "Glasgow.sortie")],
#                        ncp.min = 1,
#                        ncp.max=20,
#                        method= "Regularized",
#                        method.cv = "Kfold",
#                        nbsim=10,
#                        verbose = TRUE)
# 
# save(ncomp_all_1outcome,
#      file = paste0(data.dir, Sys.Date(),"_ncomp_all_1outcome.RData"))
```

```{r plot_ncomp_all_1outcome }
load(paste0(data.dir, "2019-06-14","_ncomp_all_1outcome.RData"))
plot(1:length(ncomp_all_1outcome$criterion), ncomp_all_1outcome$criterion, xlab = "nb dim", ylab = "MSEP")
```

By cross-validation we find ncp=18 to be the optimal number of components.

```{r famd_impute_all_1outcome}
ncp = 18
imputed_all_1outcome_FAMD <- get_FAMD(data_indAll[, !(names(data_indAll) == "Glasgow.sortie")], seed = 0, ncp=ncp, Method = "Regularized", scale = T, threshold = 1e-06)

if (population == "tbi"){
# After imputation, restrain to the target units (TBI patients)
  imputed_all_1outcome_FAMD <- imputed_all_1outcome_FAMD[imputed_all_1outcome_FAMD$Trauma.cranien %in% c("1") | imputed_all_1outcome_FAMD$AIS.tete >= 2, ]
}
```


## Latent confounders (Kallus, Mao and Udell, 2018)
We perform FAMD on the pre-treatment covariates, i.e. we put aside the treatment and outcome variables (which are fully observed in this case).

```{r select_pretreatment-confounders}
confounders <- c("Trauma.Center", "PAS.min", "PAD.min", "FC.max", 
                 "ACR.1", "Catecholamines",
                 "AIS.externe", "Hemocue.init", "Delta.hemocue", "Shock.index.ph", "Delta.shock.index")
```


First we find the optimal number of dimensions for the FAMD by cross-validation
```{r ncomp_all_mf}
# ncomp <- estim_ncpFAMD(data_indAll[,names(data_indAll) %in% confounders],
#                        ncp.min = 1,
#                        ncp.max=10,
#                        method= "Regularized",
#                        method.cv = "Kfold",
#                        nbsim=10,
#                        verbose = TRUE)
#  
# save(ncomp_all_confounders,
#      file = paste0(data.dir, Sys.Date(),"_ncomp_all_confounders.RData"))
```

```{r plot_ncomp_all_mf}
load(paste0(data.dir, "2019-06-14","_ncomp_all_confounders.RData"))
plot(1:10, ncomp_all_confounders$criterion, xlab = "nb dim", ylab = "MSEP")
```

The criterion is minimized for ncp = 10.

Then we find the principal dimensions of FAMD
```{r famd_impute_all_mf}
ncp = 10
imputed_covariates <- get_FAMD(data_indAll[,names(data_indAll) %in% confounders], 
                               seed = 0, ncp=ncp, Method = "Regularized", scale = T, threshold = 1e-06)


res.famd <- FAMD(imputed_covariates,
                 ncp = ncp, graph=F)

confounders_all_MF <- res.famd$ind$coord

if (population == "tbi"){
# After factorization, restrain to the target units (TBI patients)
  row_num <- which(data_indAll$Trauma.cranien %in% c("1") | data_indAll$AIS.tete >= 2)
  confounders_all_MF <- confounders_all_MF[row_num,]
}
```

## MICE

```{r mice_impute_all_2outcomes}
imputed_all_2outcomes_mice <- get_MICE(data_indAll, seed = 0, m=1)


if (population == "tbi"){
# After imputation, restrain to the target units (TBI patients)
  imputed_all_2outcomes_mice <- imputed_all_2outcomes_mice[imputed_all_2outcomes_mice$Trauma.cranien %in% c("1") | imputed_all_2outcomes_mice$AIS.tete >= 2, ]
}
```


```{r mice_impute_all_1outcome}
imputed_all_1outcome_mice <- get_MICE(data_indAll[, !(names(data_indAll) == "Glasgow.sortie")], seed = 0, m=1)

if (population == "tbi"){
# After imputation, restrain to the target units (TBI patients)
  imputed_all_1outcome_mice <- imputed_all_1outcome_mice[imputed_all_1outcome_mice$Trauma.cranien %in% c("1") | imputed_all_1outcome_mice$AIS.tete >= 2, ]
}
```



# Causal inference

We are interested in estimating the causal effect of the drug _tranexamic acid_ (also known as _exacyl_) on the mortality of traumatic brain injury patients.

Although most of the patients receive multiple treatments (in pre-hospital and hospital phase) and we have records of these other treatments (for instance osmotherapy, fibrinogene, etc.) we are only considering the effect of tranexamic acid on in-icu mortality. This being said, the set of covariates we are considering for each patient include measurements such as temperature, Hb, etc. but also (binary) variables indicating the administration of a drug/an intervention such as putting a catheter on the patient.


## Assess confounding

By looking at the contingency table of treatment and outcome and other means of assessing treatment bias in the data

The results in this subsection are obtained with the imputed data from imputation on the entire sample (TBI and no-TBI) and using the two outcome variables `DC.en.rea` and `Glasgow.sortie`.

```{r} 
res.table <- table(imputed_all_2outcomes_FAMD$Acide.tranexamique==1, imputed_all_2outcomes_FAMD$DC.Trauma, 
                   dnn = c("Treated","Died"))
prop.table(res.table)
```

Among the treated and the control most patients survived. But proportionally, more patients died in the treated group than in the control group. Strong indication for confounding factors that need to be controlled for, by matching or IPTW.

From the above table we can deduce the following for the population of TBI patients:

```{r}
sprintf("Mortality rate: %2.1f %%", mean(imputed_all_2outcomes_FAMD$DC.Trauma==1)*100)
sprintf("P(Treatment) : %.2f", mean(imputed_all_2outcomes_FAMD$Acide.tranexamique==1))
sprintf("P(Death | Treatment) : %.2f", mean((imputed_all_2outcomes_FAMD$DC.Trauma==1)*(imputed_all_2outcomes_FAMD$Acide.tranexamique==1))/mean(imputed_all_2outcomes_FAMD$Acide.tranexamique==1))
sprintf("P(Death |  Control) : %.2f", mean((imputed_all_2outcomes_FAMD$DC.Trauma==1)*(imputed_all_2outcomes_FAMD$Acide.tranexamique==0))/mean(imputed_all_2outcomes_FAMD$Acide.tranexamique==0))
```
These probabilities suggest that the treatment has a negative impact on the chances of survival. 

However, treated patients tend to have lower `Glasgow.initial` - and are therefore potentially more severe since according to the practitioners this covariate is a predictor for the patient's severity - which highly suggests that the treatment is not given uniformely at random.


```{r }
ggplot(data = imputed_all_2outcomes_FAMD) +
  geom_density(aes(x=Glasgow.initial, color = Acide.tranexamique, fill = Acide.tranexamique), alpha = .2) 
```

Another way to visualize the imbalance between the treated and control groups is to take the standardized mean differences in quantitative variables between the treated and the control.

```{r}
imputed_all_2outcomes_FAMD$Acide.tranexamique = as.character(imputed_all_2outcomes_FAMD$Acide.tranexamique)
imputed_all_2outcomes_FAMD$DC.Trauma = as.character(imputed_all_2outcomes_FAMD$DC.Trauma)

xvars <- names(which(sapply(imputed_all_2outcomes_FAMD, is.numeric)==TRUE))
xvars <- xvars[!xvars %in% c("Acide.tranexamique", "Glasgow.sortie")]
tab <- CreateTableOne(vars=xvars, strat="Acide.tranexamique", data=imputed_all_2outcomes_FAMD, test=FALSE)
print(tab, smd=TRUE)
```


```{r }
imputed_all_2outcomes_FAMD$Acide.tranexamique <- as.numeric(imputed_all_2outcomes_FAMD$Acide.tranexamique)
balance <- bal.tab(imputed_all_2outcomes_FAMD[colnames(imputed_all_2outcomes_FAMD) %in% xvars & !colnames(imputed_all_2outcomes_FAMD) %in% c("Acide.tranexamique", "DC.Trauma", "Glasgow.sortie")], treat = imputed_all_2outcomes_FAMD$Acide.tranexamique, estimand="ATE", continuous="std")
love.plot(x = balance, stat = "mean.diffs", abs = TRUE, var.order = "unadjusted", threshold = 0.1, cex=0.8)
```

The standardized mean differences (SMD) higher than some threshold th, for instance th=0.1, indicate that the covariate distributions in the two groups differ: the treatment is not given uniformely at random. This explains the need for some adjustment or balancing in order to perform a causal analysis of the treatment on a certain outcome.



## IPW

### On imputed data
```{r ipw_ate, warning=FALSE}
results_ipw_imp_list <- list()
results_ipw_imp <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_ipw_imp) <- c("Estimand",
                               "Imputation.method", 
                               "Imputation.ind", 
                               "Imputation.var", 
                               "PS.estimation",
                               "ATE.p100", 
                               "STD.p100")

data_list <- list(list("FAMD", population, "2outcomes", imputed_all_2outcomes_FAMD),
                  list("FAMD", population, "1outcome", imputed_all_1outcome_FAMD),
                  list("mice", population, "2outcomes", imputed_all_2outcomes_mice),
                  list("mice", population, "1outcome", imputed_all_1outcome_mice))

methods_list <- list("glm", "gbm", "grf")
idx <- 1

for (i in 1:length(data_list)){
  df <- data_list[[i]][[4]] %>% 
          dplyr::select(-c("Acide.tranexamique", "DC.Trauma")) %>%
          dplyr::select(confounders)
  
  if ("Glasgow.sortie" %in% colnames(df)) {
    df <- df %>%
          dplyr::select(-"Glasgow.sortie")
  }
  
  treatment <- data_list[[i]][[4]]$Acide.tranexamique
  outcome <- data_list[[i]][[4]]$DC.Trauma
  
  for (j in 1:length(methods_list)){
    results_ipw_imp_list[[idx]] <- ipw(X=df, outcome = outcome, treat = treatment,
                                       ps.method = methods_list[[j]], target = "all", 
                                       seed=0, trimming_weight=.999)
    results_ipw_imp <- rbind(results_ipw_imp,
                             data.frame("Estimand" = "ATE",
                                        "Imputation.method" = data_list[[i]][[1]],
                                        "Imputation.ind" = data_list[[i]][[2]],
                                        "Imputation.var" = data_list[[i]][[3]],
                                        "PS.estimation" = methods_list[[j]],
                                        "ATE.p100" = results_ipw_imp_list[[idx]][[2]]*100,
                                        "STD.p100" = results_ipw_imp_list[[idx]][[3]]*100))
    
    idx <- idx+1
  }
}


knitr::kable(results_ipw_imp, caption = "IPW estimations", digits = 2)

```

### On latent factors (from matrix factorization)
```{r ipw_mf, warning=FALSE}
results_ipw_mf_list <- list()
results_ipw_mf <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_ipw_mf) <- c("Estimand",
                               "Imputation.method", 
                               "Imputation.ind", 
                               "Imputation.var", 
                               "PS.estimation",
                               "ATE.p100", 
                               "STD.p100")

data_list <- list(list("MF", population, "-", data.frame(confounders_all_MF)))

if (population == "tbi"){
  treatment <- data_indTBI$Acide.tranexamique
  outcome <- data_indTBI$DC.Trauma
} else {
  treatment <- data_indAll$Acide.tranexamique
  outcome <- data_indAll$DC.Trauma
}
methods_list <- list("grf")#"gbm", "glm", 
idx <- 1

for (i in 1:length(data_list)){
  df <- data_list[[i]][[4]]
  
  
  for (j in 1:length(methods_list)){
    results_ipw_mf_list[[idx]] <- ipw(X=df, outcome = outcome, treat = treatment,
                                       ps.method = methods_list[[j]], target = "all", 
                                       seed=0, trimming_weight=.999)
    results_ipw_mf <- rbind(results_ipw_mf,
                             data.frame("Estimand" = "ATE",
                                        "Imputation.method" = data_list[[i]][[1]],
                                        "Imputation.ind" = data_list[[i]][[2]],
                                        "Imputation.var" = data_list[[i]][[3]],
                                        "PS.estimation" = methods_list[[j]],
                                        "ATE.p100" = results_ipw_mf_list[[idx]][[2]]*100,
                                        "STD.p100" = results_ipw_mf_list[[idx]][[3]]*100))
    
    idx <- idx+1
  }
}


knitr::kable(results_ipw_mf, caption = "IPW estimations", digits = 2)

```

### Likelihood approach
```{r ipw_at_misaem, warning=FALSE}
results_ipw_misaem_list <- list()
results_ipw_misaem <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_ipw_misaem) <- c("Estimand",
                                    "Imputation.method", 
                                    "Imputation.ind", 
                                    "Imputation.var", 
                                    "PS.estimation", 
                                    "ATE.p100", 
                                    "STD.p100")


weights_list <- list("all") #list("all", "treated", "control", "overlap", "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap", "ATE_match")


idx <- 1



covariates_misaem <- data_indAll %>%
                        dplyr::select(c(confounders, "Trauma.cranien", "Acide.tranexamique", "DC.Trauma", "AIS.tete"))


misaem.results.all <- prepare_data_misaem(covariates_misaem, use_targets = (population == "tbi"))

data_list <- list(list(population, misaem.results.all))


for (k in 1:length(weights_list)){
  for (i in 1:length(data_list)) {
    df <- data_list[[i]][[2]] %>% 
          dplyr::select(-c("Acide.tranexamique", "DC.Trauma")) %>%
          dplyr::select(confounders)
  
    if ("Glasgow.sortie" %in% colnames(df)) {
      df <- df %>%
            dplyr::select(-"Glasgow.sortie")
    }
  
    treatment <- data_list[[i]][[2]]$Acide.tranexamique
    outcome <- data_list[[i]][[2]]$DC.Trauma
    df.imp.fitted <- prepare_data_ate(df= df, w = treatment, y=outcome, 
                                      imputation.method = "saem", mask = NULL, use.interaction = F)
    results_ipw_misaem_list[[idx]] <- ipw(X = df.imp.fitted$df.imp, 
                                          ps.method = "glm",
                                          fitted = df.imp.fitted$fitted, 
                                          treat = treatment, 
                                          outcome = outcome,
                                          target = weights_list[[k]], 
                                          seed=0, trimming_weight=weights_trim_list[[k]])
  
    results_ipw_misaem <- rbind(results_ipw_misaem,
                                  data.frame("Estimand" = estimands_list[[k]],
                                             "Imputation.method" = "-",
                                             "Imputation.ind" = data_list[[i]][[1]],
                                             "Imputation.var" = "-",
                                             "PS.estimation" = "saem",
                                             "ATE.p100" = results_ipw_misaem_list[[idx]][[2]]*100,
                                             "STD.p100" = results_ipw_misaem_list[[idx]][[3]]*100))
    
    idx <- idx+1
  }
}

knitr::kable(results_ipw_misaem, caption = "IPW ATE estimations using PS scores from incomplete data", digits = 2)

```

### MIA+grf
```{r ipw_at_mia, warning=FALSE}
results_ipw_mia_list <- list()
results_ipw_mia <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_ipw_mia) <- c("Estimand",
                                 "Imputation.method", 
                                 "Imputation.ind", 
                                 "Imputation.var", 
                                 "PS.estimation", 
                                 "ATE.p100", 
                                 "STD.p100")


if (population == "tbi"){
  data_list <- list(list("mia", population, "-", get_imputeInf(data_indTBI)))
} else {
  data_list <- list(list("mia", population, "-", get_imputeInf(data_indAll)))
}

methods_list <- list( "grf")

weights_list <- list("all")#, "treated", "control", "overlap", "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap","ATE_match")

    
idx <- 1


for (k in 1:length(weights_list)){
  for (i in 1:length(data_list)) {
    treatment <- data_list[[i]][[4]]$Acide.tranexamique
    outcome <- data_list[[i]][[4]]$DC.Trauma


    df <- data_list[[i]][[4]] %>%
              dplyr::select(-c("Acide.tranexamique", "DC.Trauma")) %>%
              dplyr::select(confounders)
    
    for (j in 1:length(methods_list)){
        results_ipw_mia_list[[idx]] <- ipw(X=df, ps.method = "grf", 
                                           treat=treatment, outcome =outcome, 
                                           target = weights_list[[k]], 
                                           seed=0, 
                                           trimming_weight=weights_trim_list[[k]])
       
        
        results_ipw_mia <- rbind(results_ipw_mia,
                                  data.frame("Estimand" = estimands_list[[k]],
                                             "Imputation.method" = data_list[[i]][[1]],
                                             "Imputation.ind" = data_list[[i]][[2]],
                                             "Imputation.var" = data_list[[i]][[3]],
                                             "PS.estimation" = methods_list[[j]],
                                             "ATE.p100" = results_ipw_mia_list[[idx]][[2]]*100,
                                             "STD.p100" = results_ipw_mia_list[[idx]][[3]]*100))
        
        idx <- idx+1
    }
  }
}

knitr::kable(results_ipw_mia, caption = "ipw ATE estimations on mia covariates", digits = 2)

```

### Mean+grf
```{r ipw_at_mean, warning=FALSE}
results_ipw_mean_list <- list()
results_ipw_mean <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_ipw_mean) <- c("Estimand",
                                "Imputation.method", 
                                "Imputation.ind", 
                                "Imputation.var", 
                                "PS.estimation", 
                                "ATE.p100", 
                                "STD.p100")


if (population == "tbi"){
  data_list <- list(list("mean", population, "-", get_imputeMean(data_indTBI)))
} else {
  data_list <- list(list("mean", population, "-", get_imputeMean(data_indAll)))
}

methods_list <- list( "grf")

weights_list <- list("all")#, "treated", "control", "overlap", "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap","ATE_match")

    
idx <- 1


for (k in 1:length(weights_list)){
  for (i in 1:length(data_list)) {
    treatment <- data_list[[i]][[4]]$Acide.tranexamique
    outcome <- data_list[[i]][[4]]$DC.Trauma


    df <- data_list[[i]][[4]] %>%
              dplyr::select(-c("Acide.tranexamique", "DC.Trauma")) %>%
              dplyr::select(confounders)
    
    for (j in 1:length(methods_list)){
        results_ipw_mean_list[[idx]] <- ipw(X=df, ps.method = "grf", 
                                           treat=treatment, outcome =outcome, 
                                           target = weights_list[[k]], 
                                           seed=0, 
                                           trimming_weight=weights_trim_list[[k]])
       
        
        results_ipw_mean <- rbind(results_ipw_mean,
                                  data.frame("Estimand" = estimands_list[[k]],
                                             "Imputation.method" = data_list[[i]][[1]],
                                             "Imputation.ind" = data_list[[i]][[2]],
                                             "Imputation.var" = data_list[[i]][[3]],
                                             "PS.estimation" = methods_list[[j]],
                                             "ATE.p100" = results_ipw_mean_list[[idx]][[2]]*100,
                                             "STD.p100" = results_ipw_mean_list[[idx]][[3]]*100))
        
        idx <- idx+1
    }
  }
}

knitr::kable(results_ipw_mean, caption = "ipw ATE estimations on mean imputed covariates", digits = 2)
```

## DR


### On imputed data
```{r dr_imp, warning=FALSE}
results_dr_imp_list <- list()
results_dr_imp <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_dr_imp) <- c("Estimand",
                               "Imputation.method", 
                               "Imputation.ind", 
                               "Imputation.var", 
                               "PS.estimation",
                               "ATE.p100", 
                               "STD.p100")

data_list <- list(list("FAMD", population, "2outcomes", imputed_all_2outcomes_FAMD),
                  list("FAMD", population, "1outcome", imputed_all_1outcome_FAMD),
                  list("mice", population, "2outcomes", imputed_all_2outcomes_mice),
                  list("mice", population, "1outcome", imputed_all_1outcome_mice))

methods_list <- list("glm", "gbm", "grf.ate")
idx <- 1

for (i in 1:length(data_list)){
  df <- data_list[[i]][[4]] %>% 
          dplyr::select(-c("Acide.tranexamique", "DC.Trauma"))
  
  if ("Glasgow.sortie" %in% colnames(df)) {
    df <- df %>%
          dplyr::select(-"Glasgow.sortie")
  }
  
  df.confounders <- df %>% dplyr::select(confounders)
  
  treatment <- data_list[[i]][[4]]$Acide.tranexamique
  outcome <- data_list[[i]][[4]]$DC.Trauma
  
  for (j in 1:length(methods_list)){
    results_dr_imp_list[[idx]] <- dr(X=df.confounders, outcome = outcome, treat = treatment,
                                     X.for.outcome = df,
                                     ps.method = methods_list[[j]], out.method = methods_list[[j]],
                                     target = "all", 
                                     seed=0, trimming_weight=.999)
    results_dr_imp <- rbind(results_dr_imp,
                             data.frame("Estimand" = "ATE",
                                        "Imputation.method" = data_list[[i]][[1]],
                                        "Imputation.ind" = data_list[[i]][[2]],
                                        "Imputation.var" = data_list[[i]][[3]],
                                        "PS.estimation" = methods_list[[j]],
                                        "ATE.p100" = results_dr_imp_list[[idx]][[1]]*100,
                                        "STD.p100" = results_dr_imp_list[[idx]][[2]]*100))
    
    idx <- idx+1
  }
}


knitr::kable(results_dr_imp, caption = "DR estimations", digits = 2)

```

### On latent factors (from matrix factorization)
```{r dr_mf, warning=FALSE}
results_dr_mf_list <- list()
results_dr_mf <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_dr_mf) <- c("Estimand",
                             "Imputation.method", 
                             "Imputation.ind", 
                             "Imputation.var", 
                             "PS.estimation",
                             "ATE.p100", 
                             "STD.p100")

data_list <- list(list("MF", population, "-", confounders_all_MF, dplyr::select(imputed_all_2outcomes_FAMD,-c(confounders, "Acide.tranexamique", "DC.Trauma", "Glasgow.sortie"))))

if (population == "tbi"){
  treatment <- data_indTBI$Acide.tranexamique
  outcome <- data_indTBI$DC.Trauma
} else {
  treatment <- data_indAll$Acide.tranexamique
  outcome <- data_indAll$DC.Trauma
}

methods_list <- list("grf.ate") # "glm", "gbm",
idx <- 1

for (i in 1:length(data_list)){
  df.confounders <- data.frame(data_list[[i]][[4]])
  df <- cbind(df.confounders, data.frame(data_list[[i]][[5]]))
  
  
  for (j in 1:length(methods_list)){
    results_dr_mf_list[[idx]] <- dr(X=df.confounders, outcome = outcome, treat = treatment,
                                    X.for.outcome = df,
                                    ps.method = methods_list[[j]], out.method = methods_list[[j]],
                                    target = "all", 
                                    seed=0, trimming_weight=.999)
    results_dr_mf <- rbind(results_dr_mf,
                           data.frame("Estimand" = "ATE",
                                      "Imputation.method" = data_list[[i]][[1]],
                                      "Imputation.ind" = data_list[[i]][[2]],
                                      "Imputation.var" = data_list[[i]][[3]],
                                      "PS.estimation" = methods_list[[j]],
                                      "ATE.p100" = results_dr_mf_list[[idx]][[1]]*100,
                                      "STD.p100" = results_dr_mf_list[[idx]][[2]]*100))
    
    idx <- idx+1
  }
}


knitr::kable(results_dr_mf, caption = "DR estimations", digits = 2)

```

### Likelihood approach
```{r dr_at_misaem, warning=FALSE}
results_dr_misaem_list <- list()
results_dr_misaem <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_dr_misaem) <- c("Estimand",
                                 "Imputation.method", 
                                 "Imputation.ind", 
                                 "Imputation.var", 
                                 "PS.estimation", 
                                 "ATE.p100", 
                                 "STD.p100")


weights_list <- list("all") #list("all", "treated", "control", "overlap", "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap", "ATE_match")


idx <- 1



#covariates_misaem <- data_indAll %>%
#                        dplyr::select(c("Trauma.cranien", "Acide.tranexamique", "DC.Trauma", "AIS.tete"))


misaem.results.all <- prepare_data_misaem(data_indAll, use_targets = (population == "tbi"))

data_list <- list(list(population, misaem.results.all))


for (k in 1:length(weights_list)){
  for (i in 1:length(data_list)) {
    df <- data_list[[i]][[2]] %>% 
          dplyr::select(-c("Acide.tranexamique", "DC.Trauma"))
          
  
    if ("Glasgow.sortie" %in% colnames(df)) {
      df <- df %>%
            dplyr::select(-"Glasgow.sortie")
    }
    
    df.confounders <- df %>% dplyr::select(confounders)
  
    treatment <- data_list[[i]][[2]]$Acide.tranexamique
    outcome <- data_list[[i]][[2]]$DC.Trauma
    df.confounders.imp.fitted <- prepare_data_ate(df= df.confounders, w = treatment, y=outcome, 
                                                  imputation.method = "saem", mask = NULL, use.interaction = F)
    results_dr_misaem_list[[idx]] <- dr(X = df.confounders.imp.fitted$df.imp, 
                                        X.for.outcome = df,
                                        ps.method = "glm",
                                        out.method = "glm",
                                        fitted = df.confounders.imp.fitted$fitted, 
                                        treat = treatment, 
                                        outcome = outcome,
                                        target = weights_list[[k]], 
                                        seed=0, trimming_weight=weights_trim_list[[k]])
  
    results_dr_misaem <- rbind(results_dr_misaem,
                               data.frame("Estimand" = estimands_list[[k]],
                                          "Imputation.method" = "-",
                                          "Imputation.ind" = data_list[[i]][[1]],
                                          "Imputation.var" = "-",
                                          "PS.estimation" = "saem",
                                          "ATE.p100" = results_dr_misaem_list[[idx]][[1]]*100,
                                          "STD.p100" = results_dr_misaem_list[[idx]][[2]]*100))
    
    idx <- idx+1
  }
}

knitr::kable(results_dr_misaem, caption = "DR ATE estimations using PS scores from incomplete data", digits = 2)

```


### MIA+grf
```{r dr_at_mia, warning=FALSE}
results_dr_mia_list <- list()
results_dr_mia <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_dr_mia) <- c("Estimand",
                              "Imputation.method", 
                              "Imputation.ind", 
                              "Imputation.var", 
                              "PS.estimation", 
                              "ATE.p100", 
                              "STD.p100")


if (population == "tbi"){
  data_list <- list(list("mia", population, "-", get_imputeInf(data_indTBI)))
} else {
  data_list <- list(list("mia", population, "-", get_imputeInf(data_indAll)))
}

methods_list <- list( "grf.ate")

weights_list <- list("all")#, "treated", "control", "overlap", "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap","ATE_match")

    
idx <- 1


for (k in 1:length(weights_list)){
  for (i in 1:length(data_list)) {
    treatment <- data_list[[i]][[4]]$Acide.tranexamique
    outcome <- data_list[[i]][[4]]$DC.Trauma


    df <- data_list[[i]][[4]] %>%
              dplyr::select(-c("Acide.tranexamique", "DC.Trauma")) 
    
    df.confounders <- df %>%
                        dplyr::select(confounders)
    
    for (j in 1:length(methods_list)){
        results_dr_mia_list[[idx]] <- dr(X=df.confounders, 
                                         X.for.outcome = df,
                                         ps.method = "grf.ate", out.method = "grf.ate",
                                         treat=treatment, outcome =outcome, 
                                         target = weights_list[[k]], 
                                         seed=0, 
                                         trimming_weight=weights_trim_list[[k]])
       
        
        results_dr_mia <- rbind(results_dr_mia,
                                data.frame("Estimand" = estimands_list[[k]],
                                           "Imputation.method" = data_list[[i]][[1]],
                                           "Imputation.ind" = data_list[[i]][[2]],
                                           "Imputation.var" = data_list[[i]][[3]],
                                           "PS.estimation" = methods_list[[j]],
                                           "ATE.p100" = results_dr_mia_list[[idx]][[1]]*100,
                                           "STD.p100" = results_dr_mia_list[[idx]][[2]]*100))
        
        idx <- idx+1
    }
  }
}

knitr::kable(results_dr_mia, caption = "DR ATE estimations on mia covariates", digits = 2)

```

### Mean+grf
```{r dr_at_mean, warning=FALSE}
results_dr_mean_list <- list()
results_dr_mean <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_dr_mean) <- c("Estimand",
                               "Imputation.method", 
                               "Imputation.ind", 
                               "Imputation.var", 
                               "PS.estimation", 
                               "ATE.p100", 
                               "STD.p100")


if (population == "tbi"){
  data_list <- list(list("mean", population, "-", get_imputeMean(data_indTBI)))
} else {
  data_list <- list(list("mean", population, "-", get_imputeMean(data_indAll)))
}

methods_list <- list( "grf.ate")

weights_list <- list("all")#, "treated", "control", "overlap", "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap","ATE_match")

    
idx <- 1


for (k in 1:length(weights_list)){
  for (i in 1:length(data_list)) {
    treatment <- data_list[[i]][[4]]$Acide.tranexamique
    outcome <- data_list[[i]][[4]]$DC.Trauma


    df <- data_list[[i]][[4]] %>%
              dplyr::select(-c("Acide.tranexamique", "DC.Trauma"))
    
    df.confounders <- df %>%
                        dplyr::select(confounders)
    
    for (j in 1:length(methods_list)){
        results_dr_mean_list[[idx]] <- dr(X=df.confounders, X.for.outcome = df,
                                          ps.method = "grf.ate", out.method = "grf.ate",
                                          treat=treatment, outcome =outcome, 
                                          target = weights_list[[k]], 
                                          seed=0, 
                                          trimming_weight=weights_trim_list[[k]])
       
        
        results_dr_mean <- rbind(results_dr_mean,
                                 data.frame("Estimand" = estimands_list[[k]],
                                            "Imputation.method" = data_list[[i]][[1]],
                                            "Imputation.ind" = data_list[[i]][[2]],
                                            "Imputation.var" = data_list[[i]][[3]],
                                            "PS.estimation" = methods_list[[j]],
                                            "ATE.p100" = results_dr_mean_list[[idx]][[1]]*100,
                                            "STD.p100" = results_dr_mean_list[[idx]][[2]]*100))
        
        idx <- idx+1
    }
  }
}

knitr::kable(results_dr_mean, caption = "DR ATE estimations on mean imputed covariates", digits = 2)
```


## Plots
```{r plot_ate_ipw_dr_grf, echo=F, warning = F, message = F}
# Aggregate DR results
levels(results_dr_misaem$PS.estimation) <- c("saem")

results_dr <- rbind(results_dr_imp,
                    results_dr_mia,
                    results_dr_misaem,
                    results_dr_mf,
                    results_dr_mean)

levels(results_dr$Imputation.method) <- toupper(levels(results_dr$Imputation.method))

# Compare ATE estimation with PS obtained by GRF
results_dr_ate <- results_dr %>%
                     filter(Estimand == "ATE" & PS.estimation %in% c("grf", "grf.ate", "saem") & Imputation.method %in% c("MICE","FAMD","MF","-","MIA","MEAN")) %>%
                     filter(!(Imputation.method %in% c("FAMD","MICE")) | (Imputation.method %in% c("FAMD","MICE") & Imputation.var == "2outcomes"))

# Match ATE estimations with corresponding computed bootstrap CI bounds
results_dr_ate$CI.inf.p100 <- results_dr_ate$ATE.p100 - 1.96*results_dr_ate$STD.p100
results_dr_ate$CI.sup.p100 <- results_dr_ate$ATE.p100 + 1.96*results_dr_ate$STD.p100



# Aggregate IPW results
levels(results_ipw_misaem$PS.estimation) <- c("saem")

results_ipw <- rbind(results_ipw_imp,
                     results_ipw_mia,
                     results_ipw_misaem,
                     results_ipw_mf,
                     results_ipw_mean)

levels(results_ipw$Imputation.method) <- toupper(levels(results_ipw$Imputation.method))

# Compare ATE estimation with PS obtained by GBM
results_ipw_ate <- results_ipw %>%
                     filter(Estimand == "ATE" & Imputation.method %in% c("MICE","FAMD","MF","-","MIA", "MEAN"))  %>%
                     filter(!(Imputation.method %in% c("FAMD","MICE")) | (Imputation.method %in% c("FAMD","MICE") & Imputation.var == "2outcomes"))

# Match ATE estimations with corresponding computed bootstrap CI bounds (if available)
results_ipw_ate$CI.inf.p100 <- results_ipw_ate$ATE.p100 - 1.96*results_ipw_ate$STD.p100
results_ipw_ate$CI.sup.p100 <- results_ipw_ate$ATE.p100 + 1.96*results_ipw_ate$STD.p100



results_ate <- rbind(cbind(results_dr_ate, "type"=rep("dr", dim(results_dr_ate)[1])),
                     cbind(results_ipw_ate,"type"=rep("ipw", dim(results_ipw_ate)[1])))

levels(results_ate$PS.estimation) <- c("glm", "gbm", "grf.ate", "grf.ate", "saem")

knitr::kable(results_ate, caption = "ATE estimations", digits = 2)

results_ate$Imputation.set <- interaction(results_ate$Imputation.method,
                                 results_ate$PS.estimation) 

rows.subset <- 1:dim(results_ate)[1]#which(results_ate_logitreg$PS.estimation %in% c("saem", "grf"))


ggplot(data=results_ate[rows.subset, ], 
       aes(x=Imputation.set, y = ATE.p100, color=Imputation.method, shape = type)) +
  geom_errorbar(aes(ymin=CI.inf.p100, ymax=CI.sup.p100, linetype = type), width=0.8, size=1) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept=0) +
  coord_flip() + 
  colScale +
  theme(axis.text=element_text(size=15)) +
  scale_x_discrete(labels = c("MEAN.grf.ate" = "(e) Mean", 
                              "FAMD.grf.ate"="(a) imputation (PC-based)", 
                              "-.saem"="(b) SAEM", 
                              "MIA.grf.ate"="(c) MIA", 
                              "MF.grf.ate"="(d) MF",
                              "MICE.grf.ate" ="(f) imputation (MICE)"),
                   limits = rev(c("FAMD.grf.ate", "-.saem",  "MIA.grf.ate", "MF.grf.ate", "MEAN.grf.ate", "MICE.grf.ate")),
                   position="top") +
  ylab("ATE (in %)") +
  ylim(c(-20,20)) +
  labs(title="ATE estimation", cex=0.7)

#ggsave(paste0(fig.dir,Sys.Date(),"ipw_dr_ate_", population,"patients.pdf"), plot = last_plot())
```
       