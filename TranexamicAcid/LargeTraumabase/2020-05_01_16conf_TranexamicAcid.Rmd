---
title: "16 confounders - Treatment Effect of Tranexamic Acid on TBI patients - on large Traumabase (20,000 patients)"
author: "Imke Mayer"
date: "05/01/2020"
output: 
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache= TRUE)
```


**We use 16 confounders.**

**We use the following set of confounders in this analysis: `Trauma.center`, `Cardiac.arrest.ph`, `SBP.ph.min, DBP.ph.min, HR.ph.max`, `SBP.ph, DBP.ph, HR.ph`, `Shock.index.ph` (`HR.ph`/`SBP.ph`), `Cristalloid.volume`, `Colloid.volume`, `SpO2.ph.min`, `Vasopressor.therapy`, `HemoCue.init`, `Delta.hemoCue`, `AIS.external`.**

**Removed `Activation.HS.procedure`**


# Preliminaries
## Choose population
Estimate ATE on the entire population or only on TBI patients?
```{r }
population <- "tbi"
```

## Load libraries

```{r load_libraries, results='hide'}
suppressPackageStartupMessages(library(cobalt))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(tableone))

suppressPackageStartupMessages(library(caret)) # 
suppressPackageStartupMessages(library(randomForest)) # Random Forests
suppressPackageStartupMessages(library(ranger)) # Random Forests prediction
suppressPackageStartupMessages(library(FactoMineR)) # Factorial data analysis
suppressPackageStartupMessages(library(grf)) # Doubly robust treatment effect estimation

suppressPackageStartupMessages(library(norm))
suppressPackageStartupMessages(library(misaem)) # Logistic regression with missing values
suppressPackageStartupMessages(library(missMDA)) # PCA/MCA with missing values + iterative PC imputation
suppressPackageStartupMessages(library(mice)) # Multiple imputation
suppressPackageStartupMessages(library(naniar)) # Missing values exploration and visualization
suppressPackageStartupMessages(library(VIM)) # Missing values exploration and visualization
suppressPackageStartupMessages(library(BaylorEdPsych)) # Little's MCAR test

suppressPackageStartupMessages(library(RColorBrewer)) # Color scale
myColors <- brewer.pal(6,"Set1")
names(myColors) <- c("-", "FAMD", "MF", "MIA", "MICE", "MEAN")
colScale <- scale_colour_manual(name = "Imputation.method",values = myColors)


# Set random generator seed for reproducible results
set.seed(0)

# Define data directory
data.dir <- "~/Documents/TraumaMatrix/CausalInference/AcideTranexamique/Data/"
rdata.dir <- "~/Documents/TraumaMatrix/CausalInference/Simulations/causal-inference-missing/TranexamicAcid/LargeTraumabase/RData/"
fig.dir <- "~/Documents/TraumaMatrix/CausalInference/Simulations/causal-inference-missing/TranexamicAcid/LargeTraumabase/Figures/"
helper.dir <- "~/Documents/TraumaMatrix/CausalInference/Simulations/causal-inference-missing/"
source(paste0(helper.dir, "Helper/helper_imputation.R"))
source(paste0(helper.dir, "Helper/helper_causalInference.R"))
source(paste0(helper.dir, "TranexamicAcid/load.R"))
```

## Load data
Run R markdown `2020-01-06_PrepareDataForATE.Rmd` prior to this to pre-process and save the data for the following analyses.
```{r load_data_for_ate}
data_indAll <- read.csv(paste0(data.dir, "2020-01-06_large_data_preprocessed_all_individuals.csv"), row.names = 1)


data_indTBI <- read.csv(paste0(data.dir, "2020-01-06_large_data_preprocessed_tbi_individuals.csv"), row.names = 1)
```

Before removing the `Activation.HS.procedure` variable, let us look at how the treatment is distributed w.r.t. this variable
```{r remove_hs_procedure}
data_indTBI$Activation.HS.procedure <- as.character(data_indTBI$Activation.HS.procedure)
data_indTBI$Activation.HS.procedure[which(is.na(data_indTBI$Activation.HS.procedure))] <- "NA"
data_indTBI$Activation.HS.procedure <- as.factor(data_indTBI$Activation.HS.procedure)
res.table <- table(data_indTBI$Tranexamic.acid==1, data_indTBI$Activation.HS.procedure, 
                   dnn = c("Treated","Activation.HS.procedure"))
print(res.table)

data_indAll <- dplyr::select(data_indAll, -c("Activation.HS.procedure"))
data_indTBI <- dplyr::select(data_indTBI, -c("Activation.HS.procedure"))
```

```{r unadjusted_ate}
if (population == "tbi"){
   unadjusted_ate <- mean(data_indTBI$Death[which(data_indTBI$Tranexamic.acid==max(data_indTBI$Tranexamic.acid))]) - mean(data_indTBI$Death[which(data_indTBI$Tranexamic.acid==min(data_indTBI$Tranexamic.acid))])
} else {
   unadjusted_ate <- mean(data_indAll$Death[which(data_indAll$Tranexamic.acid==max(data_indAll$Tranexamic.acid))]) - mean(data_indAll$Death[which(data_indAll$Tranexamic.acid==min(data_indAll$Tranexamic.acid))])
}
```

```{r, confounders}
confounders <- c("Trauma.center", 
                 "SBP.ph", "DBP.ph", "HR.ph", 
                 "SBP.ph.min", "DBP.ph.min", "HR.ph.max",  
                 "Cardiac.arrest.ph", "Vasopressor.therapy", "SpO2.ph.min",
                 "AIS.external", "HemoCue.init", "Delta.hemoCue", "Shock.index.ph", "Cristalloid.volume", "Colloid.volume")
```

# Imputation

We impute the data with different methods (iterative FAMD, mice) and using different subsets of individuals.

i) All individuals (TBI and no-TBI patients)

ii) Only TBI patients


Note: Reference for how to handle missing values in the outcome: von Hippel, P. T., Regression with missing Ys: An improved strategy for analyzing multiply imputed data  (2007) https://onlinelibrary.wiley.com/doi/full/10.1111/j.1467-9531.2007.00180.x

## FAMD
For case 1, it is important to go back to the original dataset, instead of focusing just on the patients with trauma cranien and/or AIS.tete >= 2 to compute the missing data. Even though we will only keep the patients with trauma cranien and/or AIS.tete>=2 while running the causal inference analysis, including the other patients at this stage will allow the imputation of missing data to be more informed by adding additional observations for comparison purposes.

Let's look at the matrix plot to identify if there are any variables that tend to be missing together or if we can detect any clear violation of the missing completely at random hypothesis:

```{r }
matrixplot(data_indAll, sortby = 2, las=2, cex.axis = 0.3)
```

We do not observe any area predomently red that coincides with others that are particularly dark/light, that would make us suspect the MCAR hypothesis.

We can also run MCA on the missing and non missing entries to double check our conclusion and to check if other groups of variables tend to be missing together:
```{r }
data_miss <- data.frame(is.na(data_indAll))
data_miss <- apply(X=data_miss, FUN=function(x) if(x) "m" else "o", MARGIN=c(1,2))
res.mca <- MCA(data_miss, graph = FALSE)
plot(res.mca, invis = "ind", title = "MCA graph of the categories", cex =0.5)
```



We now perform a single imputation with a (regularized) iterative Factorial Analysis for Mixed Data model, which will allow imputation to take into account similarities between both individuals and relationships between variables. See: https://arxiv.org/pdf/1301.4797.pdf

First we find the optimal number of dimensions for the FAMD by cross-validation
```{r ncomp_all}
# ncomp_famd <- estim_ncpFAMD(data_indTBI,
# ncp.min = 1,
# ncp.max=15,
# method= "Regularized",
# method.cv = "Kfold",
# nbsim=10,
# verbose = TRUE)
# 
# save(ncomp_famd,
#      file = paste0(rdata.dir, Sys.Date(),"_large_data_17confounders_ncomp_famd.RData"))
```

```{r plot_ncomp_all}
load(paste0(rdata.dir, "2020-01-06","_large_data_17confounders_ncomp_famd.RData")) 
plot(1:length(ncomp_famd$criterion), ncomp_famd$criterion, xlab = "nb dim", ylab = "MSEP")
```

By cross-validation we find ncp=6 to be the optimal number of components.

```{r famd_impute}
# ncp = 6
# imputed_FAMD <- get_FAMD(data_indTBI, seed = 0, ncp=ncp, Method = "Regularized", scale = T, threshold = 1e-06)
# 
# res.famd <- FAMD(imputed_FAMD,
#                  ncp = ncp, graph=F)
# 
# if (population == "tbi"){
# # After imputation, restrain to the target units (TBI patients)
#   rows.FAMD <- which(imputed_FAMD$TBI %in% c("1") | imputed_FAMD$AIS.head >= 2)
#   imputed_FAMD <- imputed_FAMD[rows.FAMD, ]
# }
```

```{r save_famd, echo=F}
# write.csv(imputed_FAMD, 
#             file = paste0(data.dir, Sys.Date(), "_large_data_16confounders", dim(data_indTBI)[2], "variables_FAMD.csv"))
# 
# save(imputed_FAMD,rows.FAMD, file = paste0(rdata.dir, Sys.Date(), "_large_data_16confounders", dim(data_indTBI)[2], "variables_FAMD.RData"))
```

```{r read_famd, echo=F}
load(file = paste0(rdata.dir, "2020-04-26", "_large_data_16confounders", dim(data_indTBI)[2], "variables_FAMD.RData"))

imputed_FAMD$Cardiac.arrest.ph <- as.factor(imputed_FAMD$Cardiac.arrest.ph)
imputed_FAMD$Anticoagulant.therapy <- as.factor(imputed_FAMD$Anticoagulant.therapy)
imputed_FAMD$Antiplatelet.therapy <- as.factor(imputed_FAMD$Antiplatelet.therapy)

levels(imputed_FAMD$Cardiac.arrest.ph) <- c(FALSE, TRUE)
levels(imputed_FAMD$Anticoagulant.therapy) <- c(FALSE, TRUE)
levels(imputed_FAMD$Antiplatelet.therapy) <- c(FALSE, TRUE)
for (j in 1:dim(imputed_FAMD)[2]){
  if (length(unique(imputed_FAMD[,j]))==2){
    imputed_FAMD[,j] <- as.logical(imputed_FAMD[,j])
  }
}
if ("Trauma.center" %in% colnames(imputed_FAMD)){
  imputed_FAMD$Trauma.center <- as.factor(imputed_FAMD$Trauma.center)
}
```



## MICE

```{r mice_impute}
# imputed_mice <- get_MICE(data_indTBI, seed = 0, m=5)
# 
# if (population == "tbi"){
# # After imputation, restrain to the target units (TBI patients)
#   rows.mice <- list()
#   for (k in 1:5){
#     rows.mice[[k]] <- which(imputed_mice[[k]]$TBI %in% c("1") | imputed_mice[[k]]$AIS.head >= 2)
#     imputed_mice[[k]] <- imputed_mice[[k]][rows.mice[[k]], ]
#   }
# }
```


```{r save_mice, echo=F}
# for (k in 1:5){
#   write.csv(imputed_mice[[k]],
#             file = paste0(data.dir, Sys.Date(), "_large_data_16confounders", dim(data_indTBI)[2], "variables_mice_seed0_m", k,".csv"))
# }
# save(imputed_mice,rows.mice,file = paste0(rdata.dir, Sys.Date(), "_large_data_16confounders", dim(data_indTBI)[2], "variables_mice.RData"))
```

```{r load_mice, echo=F}
load(file = paste0(rdata.dir, "2020-04-26_large_data_16confounders", dim(data_indTBI)[2], "variables_mice.RData"))

for (i in 1:length(imputed_mice)){
  imputed_mice[[i]]$Cardiac.arrest.ph <- as.factor(imputed_mice[[i]]$Cardiac.arrest.ph)
  imputed_mice[[i]]$Anticoagulant.therapy <- as.factor(imputed_mice[[i]]$Anticoagulant.therapy)
  imputed_mice[[i]]$Antiplatelet.therapy <- as.factor(imputed_mice[[i]]$Antiplatelet.therapy)

  levels(imputed_mice[[i]]$Cardiac.arrest.ph) <- c(FALSE, TRUE)
  levels(imputed_mice[[i]]$Anticoagulant.therapy) <- c(FALSE, TRUE)
  levels(imputed_mice[[i]]$Antiplatelet.therapy) <- c(FALSE, TRUE)

  for (j in 1:dim(imputed_mice[[i]])[2]){
    if (length(unique(imputed_mice[[i]][,j]))==2){
      imputed_mice[[i]][,j] <- as.logical(imputed_mice[[i]][,j])
    }
  }
  if ("Trauma.center" %in% colnames(imputed_mice[[i]])){
    imputed_mice[[i]]$Trauma.center <- as.factor(imputed_mice[[i]]$Trauma.center)
  }
}

```




# Causal inference

We are interested in estimating the causal effect of the drug _tranexamic acid_ (also known as _exacyl_) on the mortality of traumatic brain injury patients.

Although most of the patients receive multiple treatments (in pre-hospital and hospital phase) and we have records of these other treatments (for instance osmotherapy, fibrinogene, etc.) we are only considering the effect of tranexamic acid on in-icu mortality. This being said, the set of covariates we are considering for each patient include measurements such as temperature, Hb, etc. but also (binary) variables indicating the administration of a drug/an intervention such as putting a catheter on the patient.


## Assess confounding

By looking at the contingency table of treatment and outcome and other means of assessing treatment bias in the data

The results in this subsection are obtained with the imputed data from imputation on the entire sample (TBI and no-TBI) and using the two outcome variables `DC.en.rea` and `Glasgow.sortie`.

```{r} 
res.table <- table(imputed_FAMD$Tranexamic.acid==1, imputed_FAMD$Death==1, 
                   dnn = c("Treated","Died"))
prop.table(res.table)
```

Among the treated and the control most patients survived. But proportionally, more patients died in the treated group than in the control group. Strong indication for confounding factors that need to be controlled for, by matching or IPTW.

From the above table we can deduce the following for the population of TBI patients:

```{r}
sprintf("Mortality rate: %2.1f", mean(imputed_FAMD$Death==1))
sprintf("P(Treatment) : %.2f", mean(imputed_FAMD$Tranexamic.acid==1))
sprintf("P(Death | Treatment) : %.2f", mean((imputed_FAMD$Death==1)*(imputed_FAMD$Tranexamic.acid==1))/mean(imputed_FAMD$Tranexamic.acid==1))
sprintf("P(Death |  Control) : %.2f", mean((imputed_FAMD$Death==1)*(imputed_FAMD$Tranexamic.acid==0))/mean(imputed_FAMD$Tranexamic.acid==0))
sprintf("ATE without adjustment : %.2f", mean(imputed_FAMD$Death[which(imputed_FAMD$Tranexamic.acid==1)])-mean(imputed_FAMD$Death[which(imputed_FAMD$Tranexamic.acid==0)]))
```
These probabilities suggest that the treatment has a negative impact on the chances of survival. 

However, treated patients tend to have lower `Glasgow.initial` - and are therefore potentially more severe since according to the practitioners this covariate is a predictor for the patient's severity - which highly suggests that the treatment is not given uniformely at random.


```{r }
ggplot(data = imputed_FAMD) +
  geom_density(aes(x=GCS.init, color = Tranexamic.acid, fill = Tranexamic.acid), alpha = .2) 
```





The standardized mean differences (SMD) higher than some threshold th, for instance th=0.1, indicate that the covariate distributions in the two groups differ: the treatment is not given uniformely at random. This explains the need for some adjustment or balancing in order to perform a causal analysis of the treatment on a certain outcome.

## Balance plots and propensity scores

### FAMD
```{r balance_overlap_famd-grf, echo=F}
df.ps <- imputed_FAMD[, confounders]
X.m = model.matrix(~. , data=data.frame(df.ps))
forest.W = regression_forest(X.m, as.logical(imputed_FAMD$Tranexamic.acid), tune.parameters = "all")
w.hat = predict(forest.W, X.m)$predictions
weights = as.numeric(as.logical(imputed_FAMD$Tranexamic.acid))/w.hat + (1-as.numeric(as.logical(imputed_FAMD$Tranexamic.acid)))/(1-w.hat)

balance <- bal.tab(imputed_FAMD[, confounders], treat = imputed_FAMD$Tranexamic.acid, 
                   estimand="ATE", continuous="std", weights = weights)

pdf(paste0(fig.dir, Sys.Date(),"_smd_confounders_famd.pdf"))
love.plot(x = balance, stat = "mean.diffs", abs = TRUE, var.order = "unadjusted", threshold = 0.1, cex=0.8)
dev.off()

pdf(paste0(fig.dir, Sys.Date(),"_ps_grf_famd.pdf"))
bal.plot(obj=data.frame(treat=as.logical(imputed_FAMD$Tranexamic.acid), ps=w.hat, weights=weights), var.name = "ps", which = "both",
         treat=as.logical(imputed_FAMD$Tranexamic.acid),
         weights=weights,
         type = "histogram", mirror = TRUE)
dev.off()
```

### MICE
```{r balance_overlap_mice-grf, echo=F}
w.hat <- list()
weights <- list()
df.ps <- list()
for (i in 1:length(imputed_mice)){
  df.ps[[i]] <- imputed_mice[[i]][, confounders]
  X.m = model.matrix(~. , data=data.frame(df.ps[[i]]))
  forest.W = regression_forest(X.m, as.logical(imputed_mice[[i]]$Tranexamic.acid), tune.parameters = "all")
  w.hat[[i]] = predict(forest.W, X.m)$predictions
  weights[[i]] = as.numeric(as.logical(imputed_mice[[i]]$Tranexamic.acid))/w.hat[[i]] + (1-as.numeric(as.logical(imputed_mice[[i]]$Tranexamic.acid)))/(1-w.hat[[i]])
}
balance <- list()
for (i in 1:length(imputed_mice)){
  balance[[i]] <- bal.tab(data_indTBI[,confounders], 
                     treat = imputed_mice[[i]]$Tranexamic.acid,
                     estimand="ATE",
                     continuous="std", 
                     weights=weights[[i]])
}

for (i in 1:length(imputed_mice)){
  pdf(paste0(fig.dir, Sys.Date(),"_smd_confounders_mice",i,".pdf"))
  plt <- love.plot(x = balance[[i]], stat = "mean.diffs", abs = TRUE, var.order = "unadjusted", threshold = 0.1, cex=0.8)
  print(plt)
  dev.off()
  
  pdf(paste0(fig.dir, Sys.Date(),"_ps_grf_mice",i,".pdf"))
  plt <- bal.plot(obj=data.frame(treat=as.logical(imputed_mice[[i]]$Tranexamic.acid), ps=w.hat[[i]], weights=weights[[i]]), var.name = "ps", which = "both",
         treat=as.logical(imputed_mice[[i]]$Tranexamic.acid),
         weights=weights[[i]],
         type = "histogram", mirror = TRUE)
  print(plt)
  dev.off()
}

incomplete_confounders <- confounders[which(sapply(data_indTBI[,confounders], function(x) sum(is.na(x))>0))]
df <- data.frame(is.na(data_indTBI[,incomplete_confounders]))
colnames(df) <- paste(incomplete_confounders, "_NA", sep="")

balance <- bal.tab(df, treat = data_indTBI$Tranexamic.acid, estimand="ATE", weights = weights[[1]])

pdf(paste0(fig.dir, Sys.Date(),"_smd_confoundersNA_mice1.pdf"))
love.plot(x = balance, stat = "mean.diffs", abs = TRUE, var.order = "unadjusted", threshold = 0.1, cex=0.8)
dev.off()
```

### GRF - MIA
```{r balance_overlap_grf-mia, echo=FALSE}
na.action <- options()$na.action
options(na.action='na.pass')
df.ps <- data_indTBI[, confounders]
X.m = model.matrix(~. , data=data.frame(df.ps))
options(na.action=na.action)
forest.W = regression_forest(X.m, as.logical(data_indTBI$Tranexamic.acid), tune.parameters = "all")
w.hat = predict(forest.W, X.m)$predictions
weights = as.numeric(as.logical(data_indTBI$Tranexamic.acid))/w.hat + (1-as.numeric(as.logical(data_indTBI$Tranexamic.acid)))/(1-w.hat)

pdf(paste0(fig.dir, Sys.Date(),"_ps_grf_grf-mia.pdf"))
bal.plot(obj=data.frame(treat=as.logical(data_indTBI$Tranexamic.acid), ps=w.hat, weights=weights), var.name = "ps", which = "both",
         treat=as.logical(data_indTBI$Tranexamic.acid),
         weights=weights,
         type = "histogram", mirror = TRUE)
dev.off()

balance <- bal.tab(data_indTBI[, confounders], treat = data_indTBI$Tranexamic.acid, estimand="ATE", continuous="std", weights = weights)
love.plot(x = balance, stat = "mean.diffs", abs = TRUE, var.order = "unadjusted", continuous="std", threshold = 0.1, cex=0.8)

incomplete_confounders <- confounders[which(sapply(data_indTBI[,confounders], function(x) sum(is.na(x))>0))]
df <- data.frame(is.na(data_indTBI[,incomplete_confounders]))
colnames(df) <- paste(incomplete_confounders, "_NA", sep="")
balance <- bal.tab(df, treat = data_indTBI$Tranexamic.acid, estimand="ATE", weights = weights)

pdf(paste0(fig.dir, Sys.Date(),"_smd_confoundersNA_grf-mia.pdf"))
love.plot(x = balance, stat = "mean.diffs", abs = TRUE, var.order = "unadjusted", threshold = 0.1, cex=0.8)
dev.off()
```



## IPW

### On imputed data
```{r ipw_ate, warning=FALSE}
results_ipw_imp_list <- list()
results_ipw_imp <- data.frame(matrix(ncol=8, nrow=0), row.names = NULL)
colnames(results_ipw_imp) <- c("Estimand",
                               "Imputation.method", 
                               "Imputation.ind",
                               "PS.estimation",
                               "Mask",
                               "ATE.p100", 
                               "STD.p100",
                               "ATE1.p100")

data_list <- list(list("FAMD", population, imputed_FAMD),
                  list("mice", population, imputed_mice))

methods_list <- list("glm", "grf.ate")

weights_list <- list("all", "treated", "control", "overlap")#, "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1)#, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap")#,"ATE_match")

idx <- 1

for (use.mask in c(TRUE)){
  for (l in 1:length(weights_list)){
    for (i in 1:length(data_list)){
      if (data_list[[i]][[1]]=="mice"){
        df <- list()
        mask <- NULL
        outcome <- treatment <- list()
        if (use.mask) mask <- list()
        for (k in 1:length(data_list[[i]][[3]])){
          df[[k]] <- data_list[[i]][[3]][[k]] %>% 
                        dplyr::select(-c("Tranexamic.acid", "Death")) %>%
                        dplyr::select(confounders)
    
    
          if (use.mask){
            if (population == "tbi"){
              mask[[k]] <- is.na(data_indTBI[rows.mice[[k]],colnames(df[[k]])])
              mask[[k]] <- mask[[k]][,sapply(data.frame(mask[[k]] ), FUN = function(x) length(unique(x))==2)]
            } else {
              mask[[k]] <- is.na(data_indAll[,colnames(df[[k]])])
              mask[[k]] <- mask[[k]][,sapply(data.frame(mask[[k]]), FUN = function(x) length(unique(x))==2)]
            }
          }
          treatment[[k]] <- as.numeric(as.logical(data_list[[i]][[3]][[k]]$Tranexamic.acid))
          outcome[[k]] <- as.numeric(as.logcial(data_list[[i]][[3]][[k]]$Death))
        }
        
      }
        
      else {
          df <- data_list[[i]][[3]] %>% 
                  dplyr::select(-c("Tranexamic.acid", "Death")) %>%
                  dplyr::select(all_of(confounders))
          
          mask <- NULL
          if (use.mask){
            if (population == "tbi"){
              mask <- is.na(data_indTBI[rows.FAMD,colnames(df)])
              mask <- mask[,sapply(data.frame(mask), FUN = function(x) length(unique(x))==2)]
            } else {
              mask <- is.na(data_indAll[,colnames(df)])
              mask <- mask[,sapply(data.frame(mask), FUN = function(x) length(unique(x))==2)]
            }
          }
          treatment <- as.numeric(as.logical(data_list[[i]][[3]]$Tranexamic.acid))
          outcome <- as.numeric(as.logical(data_list[[i]][[3]]$Death))
        }
      
      
      
      for (j in 1:length(methods_list)){
        if (data_list[[i]][[1]]== "mice"){
          tmp <- c()
          for (k in 1:length(data_list[[i]][[3]])){
            print(k)
            tmp <- rbind(tmp, ipw(X=df[[k]], outcome = outcome[[k]], treat = treatment[[k]],
                                             mask = mask[[k]],
                                             ps.method = methods_list[[j]], target = weights_list[[l]], 
                                             seed=0, trimming_weight=weights_trim_list[[l]]))
          }
          results_ipw_imp_list[[idx]] <- apply(tmp, 2, mean)
          results_ipw_imp_list[[idx]][[3]] <- results_ipw_imp_list[[idx]][[3]] +
                                                (1+ 1/5)*sum((tmp[,2] - results_ipw_imp_list[[idx]][[2]])^2)/4
          
        }
        else {
          results_ipw_imp_list[[idx]] <- ipw(X=df, outcome = outcome, treat = treatment,
                                             mask = mask,
                                             ps.method = methods_list[[j]], target = weights_list[[l]], 
                                             seed=0, trimming_weight=weights_trim_list[[l]])
          
        }
        results_ipw_imp <- rbind(results_ipw_imp,
                                   data.frame("Estimand" = estimands_list[[l]],
                                              "Imputation.method" = data_list[[i]][[1]],
                                              "Imputation.ind" = data_list[[i]][[2]],
                                              "PS.estimation" = methods_list[[j]],
                                              "Mask" = use.mask,
                                              "ATE.p100" = results_ipw_imp_list[[idx]][[2]]*100,
                                              "STD.p100" = results_ipw_imp_list[[idx]][[3]]*100,
                                              "ATE1.p100" = results_ipw_imp_list[[idx]][[1]]*100))
        
        idx <- idx+1
      }
    }
  }
}

knitr::kable(results_ipw_imp, caption = "IPW estimations", digits = 2)

```

### MIA+grf
```{r ipw_at_mia, warning=FALSE}
results_ipw_mia_list <- list()
results_ipw_mia <- data.frame(matrix(ncol=8, nrow=0), row.names = NULL)
colnames(results_ipw_mia) <- c("Estimand",
                                 "Imputation.method", 
                                 "Imputation.ind", 
                                 "PS.estimation", 
                                 "Mask",
                                 "ATE.p100", 
                                 "STD.p100",
                               "ATE1.p100")


if (population == "tbi"){
  data_list <- list(list("mia", population, data_indTBI))
} else {
  data_list <- list(list("mia", population, data_indAll))
}

methods_list <- list( "grf.ate")

weights_list <- list("all", "treated", "control", "overlap")#, "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1)#, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap")#,"ATE_match")

    
idx <- 1

for (use.mask in c(TRUE)){
  for (k in 1:length(weights_list)){
    
    if (population == "tbi"){
      treatment <- as.logical(data_indTBI$Tranexamic.acid)
      outcome <- as.numeric(as.logical(data_indTBI$Death))
      df <- data_indTBI %>%
              dplyr::select(-c("Tranexamic.acid", "Death")) %>%
              dplyr::select(confounders)
    } else {
      treatment <- as.logical(data_indAll$Tranexamic.acid)
      outcome <- as.numeric(as.logical(data_indAll$Death))
      df <- data_indAll %>%
              dplyr::select(-c("Tranexamic.acid", "Death")) %>%
              dplyr::select(confounders)
    }
    
    mask <- NULL
    if (use.mask){
      if (population == "tbi"){
        mask <- is.na(data_indTBI[,intersect(colnames(data_indTBI),colnames(df))])
      } else {
        mask <- is.na(data_indAll[,intersect(colnames(data_indAll),colnames(df))])
      }
    }
    
    for (j in 1:length(methods_list)){
        results_ipw_mia_list[[idx]] <- ipw(X=df, ps.method = "grf.ate", 
                                           mask = mask,
                                           treat=treatment, outcome =outcome, 
                                           target = weights_list[[k]], 
                                           seed=0, 
                                           trimming_weight=weights_trim_list[[k]])
       
        
        results_ipw_mia <- rbind(results_ipw_mia,
                                  data.frame("Estimand" = estimands_list[[k]],
                                             "Imputation.method" = "mia",
                                             "Imputation.ind" = population,
                                             "PS.estimation" = methods_list[[j]],
                                             "Mask" = use.mask,
                                             "ATE.p100" = results_ipw_mia_list[[idx]][[2]]*100,
                                             "STD.p100" = results_ipw_mia_list[[idx]][[3]]*100,
                                             "ATE1.p100" = results_ipw_mia_list[[idx]][[1]]*100))
        
        idx <- idx+1
    }
  }
}

knitr::kable(results_ipw_mia, caption = "ipw ATE estimations on mia covariates", digits = 2)

```


## DR


### On imputed data
```{r dr_imp, warning=FALSE}
results_dr_imp_list <- list()
results_dr_imp <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_dr_imp) <- c("Estimand",
                               "Imputation.method", 
                               "Imputation.ind", 
                               "PS.estimation",
                               "Mask",
                               "ATE.p100", 
                               "STD.p100")

data_list <- list(list("FAMD", population, imputed_FAMD),
                  list("mice", population, imputed_mice))

methods_list <- list("glm", "grf.ate")#"gbm",

weights_list <- list("all", "treated", "control", "overlap")#, "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1)#, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap")#,"ATE_match")

idx <- 1

for (use.mask in c(TRUE)){
  for (l in 1:length(weights_list)){
    for (i in 1:length(data_list)){
      if (data_list[[i]][[1]]=="mice"){
        df <- list()
        df.confounders <- list()
        outcome <- treatment <- list()
        mask.confounders <- NULL
        mask <- NULL
        if (use.mask) mask.confounders <- mask <- list()
        for (k in 1:length(data_list[[i]][[3]])){
          df[[k]] <- data_list[[i]][[3]][[k]] %>% 
                      dplyr::select(-c("Tranexamic.acid", "Death"))
      
      
          df.confounders[[k]] <- df[[k]] %>% dplyr::select(confounders)
      
          if (use.mask){
            if (population == "tbi"){
              mask.confounders[[k]] <- is.na(data_indTBI[,colnames(df.confounders[[k]])])
              mask.confounders[[k]] <- data.frame(mask.confounders[[k]][,sapply(data.frame(mask.confounders[[k]]), FUN = function(x) length(unique(x))==2)])
              mask[[k]] <- is.na(data_indTBI[,colnames(df[[k]])])
              mask[[k]] <- data.frame(mask[[k]][,sapply(data.frame(mask[[k]]), FUN = function(x) length(unique(x))==2)])
            } else {
              mask.confounders[[k]] <- is.na(data_indAll[,colnames(df.confounders[[k]])])
              mask.confounders[[k]] <- data.frame(mask.confounders[[k]][,sapply(data.frame(mask.confounders[[k]]), FUN = function(x) length(unique(x))==2)])
              mask[[k]] <- is.na(data_indAll[,colnames(df[[k]])])
              mask[[k]] <- data.frame(mask[[k]][,sapply(data.frame(mask[[k]]), FUN = function(x) length(unique(x))==2)])
            }
          }
          treatment[[k]] <- as.logical(data_list[[i]][[3]][[k]]$Tranexamic.acid)
          outcome[[k]] <- as.numeric(as.logical(data_list[[i]][[3]][[k]]$Death))
      
          
        }
      }
      
      else {    
        df <- data_list[[i]][[3]] %>% 
                dplyr::select(-c("Tranexamic.acid", "Death"))
        
        if ("Glasgow.sortie" %in% colnames(df)) {
          df <- df %>%
                dplyr::select(-"Glasgow.sortie")
        }
        
        df.confounders <- df %>% dplyr::select(all_of(confounders))
        
        mask.confounders <- NULL
        mask <- NULL
        if (use.mask){
          if (population == "tbi"){
            mask.confounders <- is.na(data_indTBI[,colnames(df.confounders)])
            mask.confounders <- data.frame(mask.confounders[,sapply(data.frame(mask.confounders), FUN = function(x) length(unique(x))==2)])
            mask <- is.na(data_indTBI[,colnames(df)])
            mask <- data.frame(mask[,sapply(data.frame(mask), FUN = function(x) length(unique(x))==2)])
          } else {
            mask.confounders <- is.na(data_indAll[,colnames(df.confounders)])
            mask.confounders <- data.frame(mask.confounders[,sapply(data.frame(mask.confounders), FUN = function(x) length(unique(x))==2)])
            mask <- is.na(data_indAll[,colnames(df)])
            mask <- data.frame(mask[,sapply(data.frame(mask), FUN = function(x) length(unique(x))==2)])
          }
        }
        
        treatment <- as.logical(data_list[[i]][[3]]$Tranexamic.acid)
        outcome <- as.numeric(as.logical(data_list[[i]][[3]]$Death))
      }
      
      for (j in 1:length(methods_list)){
        if (data_list[[i]][[1]] == "mice"){
          tmp <- c()
          for (k in 1:length(data_list[[i]][[3]])){
            print(k)
            tmp <- rbind(tmp, dr(X=df.confounders[[k]], outcome = outcome[[k]], treat = treatment[[k]],
                                           mask = mask.confounders[[k]],
                                           mask.for.outcome = mask[[k]],
                                           X.for.outcome = df[[k]],
                                           ps.method = methods_list[[j]], out.method = methods_list[[j]],
                                           target = weights_list[[l]], 
                                           seed=0, trimming_weight=weights_trim_list[[l]])) 
          }
          results_dr_imp_list[[idx]] <- apply(tmp, 2, mean)
          results_dr_imp_list[[idx]][[2]] <- results_dr_imp_list[[idx]][[2]] +
                                              (1+ 1/5)*sum((tmp[,1] - results_dr_imp_list[[idx]][[1]])^2)/4
        }
        else {
          results_dr_imp_list[[idx]] <- dr(X=df.confounders, outcome = outcome, treat = treatment,
                                           mask = mask.confounders,
                                           mask.for.outcome = mask,
                                           X.for.outcome = df,
                                           ps.method = methods_list[[j]], out.method = methods_list[[j]],
                                           target = weights_list[[l]], 
                                           seed=0, trimming_weight=weights_trim_list[[l]])
        }
        results_dr_imp <- rbind(results_dr_imp,
                                 data.frame("Estimand" = estimands_list[[l]],
                                            "Imputation.method" = data_list[[i]][[1]],
                                            "Imputation.ind" = data_list[[i]][[2]],
                                            "PS.estimation" = methods_list[[j]],
                                            "Mask" = use.mask,
                                            "ATE.p100" = results_dr_imp_list[[idx]][[1]]*100,
                                            "STD.p100" = results_dr_imp_list[[idx]][[2]]*100))
        
        idx <- idx+1
      }
    }
  }
}
knitr::kable(results_dr_imp, caption = "DR estimations", digits = 2)
```

### MIA+grf
```{r dr_at_mia, warning=FALSE}
results_dr_mia_list <- list()
results_dr_mia <- data.frame(matrix(ncol=7, nrow=0), row.names = NULL)
colnames(results_dr_mia) <- c("Estimand",
                              "Imputation.method", 
                              "Imputation.ind", 
                              "PS.estimation",
                              "Mask",
                              "ATE.p100", 
                              "STD.p100")


if (population == "tbi"){
  data_list <- list(list("mia", population, data_indTBI))
} else {
  data_list <- list(list("mia", population, data_indAll))
}

methods_list <- list( "grf.ate")

weights_list <- list("all", "treated", "control", "overlap")#, "matching")
weights_trim_list <- list(0.999, 0.999, 0.999, 1)#, 1)
estimands_list <- list("ATE", "ATT", "ATC", "ATE_overlap")#,"ATE_match")

    
idx <- 1

for (use.mask in c(TRUE)){
  for (k in 1:length(weights_list)){
    for (i in 1:length(data_list)) {
      treatment <- as.logical(data_list[[i]][[3]]$Tranexamic.acid)
      outcome <- as.numeric(as.logical(data_list[[i]][[3]]$Death))
  
  
      df <- data_list[[i]][[3]] %>%
                dplyr::select(-c("Tranexamic.acid", "Death")) 
      if (population == "tbi"){
        df.confounders <- data_indTBI[,confounders]
      } else {
        df.confounders <- data_indAll[,confounders]
      }
      mask.confounders <- NULL
      mask <- NULL
      if (use.mask){
        if (population == "tbi"){
          mask.confounders <- is.na(data_indTBI[,intersect(colnames(data_indTBI),colnames(df.confounders))])
          mask.confounders <- data.frame(mask.confounders[,sapply(data.frame(mask.confounders), FUN = function(x) length(unique(x))==2)])
          mask <- is.na(data_indTBI[,colnames(data_indTBI)[which(!(colnames(data_indTBI) %in% c("Tranexamic.acid", "Death", "Glasgow.sortie")))]])
          mask <- data.frame(mask[,sapply(data.frame(mask), FUN = function(x) length(unique(x))==2)])
        } else {
          mask.confounders <- is.na(data_indAll[,intersect(colnames(data_indAll),colnames(df.confounders))])
          mask.confounders <- data.frame(mask.confounders[,sapply(data.frame(mask.confounders), FUN = function(x) length(unique(x))==2)])
          mask <- is.na(data_indAll[,colnames(data_indAll)[which(!(colnames(data_indAll) %in% c("Tranexamic.acid", "Death", "Glasgow.sortie")))]])
          mask <- data.frame(mask[,sapply(data.frame(mask), FUN = function(x) length(unique(x))==2)])
        }
      }
      
      for (j in 1:length(methods_list)){
          results_dr_mia_list[[idx]] <- dr(X=df.confounders, 
                                           X.for.outcome = df,
                                           mask = mask.confounders,
                                           mask.for.outcome = mask,
                                           ps.method = "grf.ate", out.method = "grf.ate",
                                           treat=treatment, outcome =outcome, 
                                           target = weights_list[[k]], 
                                           seed=0, 
                                           trimming_weight=weights_trim_list[[k]])
         
          
          results_dr_mia <- rbind(results_dr_mia,
                                  data.frame("Estimand" = estimands_list[[k]],
                                             "Imputation.method" = data_list[[i]][[1]],
                                             "Imputation.ind" = data_list[[i]][[2]],
                                             "PS.estimation" = methods_list[[j]],
                                             "Mask" = use.mask,
                                             "ATE.p100" = results_dr_mia_list[[idx]][[1]]*100,
                                             "STD.p100" = results_dr_mia_list[[idx]][[2]]*100))
          
          idx <- idx+1
      }
    }
  }
}

knitr::kable(results_dr_mia, caption = "DR ATE estimations on mia covariates", digits = 2)
```



## Plots

```{r function_plot_combined, echo=F}
plot_ate <- function(res_dr, res_ipw, estimand, ps.estimation=c("grf", "grf.ate")){
  results_dr_ate <- res_dr %>%
                       filter(Estimand == toupper(estimand) & PS.estimation %in% ps.estimation &
                                Imputation.method %in% c("MICE","FAMD","MF","-","MIA","MEAN")) %>%
                       filter(!(Imputation.method %in% c("FAMD","MICE")) | 
                                (Imputation.method %in% c("FAMD","MICE")))

  results_dr_ate$CI.inf.p100 <- results_dr_ate$ATE.p100 - 1.96*results_dr_ate$STD.p100
  results_dr_ate$CI.sup.p100 <- results_dr_ate$ATE.p100 + 1.96*results_dr_ate$STD.p100


  results_ipw_ate <- res_ipw %>%
                       filter(Estimand == toupper(estimand) & PS.estimation %in% ps.estimation &
                                Imputation.method %in% c("MICE","FAMD","MF","-","MIA", "MEAN"))  %>%
                       filter(!(Imputation.method %in% c("FAMD","MICE")) | 
                                (Imputation.method %in% c("FAMD","MICE")))

  results_ipw_ate$CI.inf.p100 <- results_ipw_ate$ATE.p100 - 1.96*results_ipw_ate$STD.p100
  results_ipw_ate$CI.sup.p100 <- results_ipw_ate$ATE.p100 + 1.96*results_ipw_ate$STD.p100


  results_ipw_ate <- dplyr::select(results_ipw_ate, -c("ATE1.p100"))

  results_ate <- rbind(cbind(results_dr_ate, "type"=rep("dr", dim(results_dr_ate)[1])),
                       cbind(results_ipw_ate,"type"=rep("ipw", dim(results_ipw_ate)[1])))


  knitr::kable(results_ate, caption = "ATE estimations", digits = 2)

  results_ate$Imputation.set <- interaction(results_ate$Imputation.method,
                                   results_ate$PS.estimation)

  
  if ("grf" %in% ps.estimation & !("glm" %in% ps.estimation)){
    levels(results_ate$PS.estimation) <- rep("grf.ate", length(levels(results_ate$PS.estimation)))
  }
  results_ate$Imputation.set <- interaction(results_ate$Imputation.method,
                                            results_ate$PS.estimation)

  df_plot <- results_ate[which(results_ate$Imputation.method %in% c("MICE","MIA")),]
  y.min <- max(-20,min(df_plot$CI.inf.p100, na.rm=T)-2)
  y.max <- min(20, max(df_plot$CI.sup.p100, na.rm=T)+2)
  
  plt <- ggplot(data=results_ate[which(df_plot$Imputation.method %in% c("MICE","MIA")),],
         aes(x=Imputation.set, y = ATE.p100, color=Imputation.method)) +
    geom_errorbar(aes(ymin=CI.inf.p100, ymax=CI.sup.p100, linetype = as.factor(type)), width=0.8, size=0.8) +
    geom_hline(yintercept = 100*unadjusted_ate, colour = "cyan", linetype = "dashed", size = 0.8) +
    geom_hline(yintercept=0) +
    coord_flip() +
    colScale +
    theme(axis.text=element_text(size=15)) +
    scale_x_discrete(labels = c("MIA.grf.ate" = "(a) GRF",
                                "MICE.grf.ate" ="(b) imputation (MICE)"),
                     limits = rev(c("MIA.grf.ate", "MICE.grf.ate")),
                     position="top") +
    ylab(paste0(toupper(estimand)," (x 100)")) +
    ylim(c(y.min,y.max)) +
    labs(title=paste0(toupper(estimand)," estimation on ", population," patients"), cex=0.7)
  return(plt)
}
```

```{r combine_results, echo=F, warning = F, message = F}
# Aggregate DR results
results_dr <- rbind(results_dr_imp,
                    results_dr_mia)

levels(results_dr$Imputation.method) <- toupper(levels(results_dr$Imputation.method))

# Aggregate IPW results
results_ipw <- rbind(results_ipw_imp,
                     results_ipw_mia)

levels(results_ipw$Imputation.method) <- toupper(levels(results_ipw$Imputation.method))
```

### ATE
```{r plot_ate}
plt <- plot_ate(results_dr, results_ipw, "ATE", ps.estimation=c("grf", "grf.ate"))

print(plt)
ggsave(paste0(fig.dir,Sys.Date(),"_large_data_16confounders_ipw_dr_ate_", population,"patients.pdf"), plot = last_plot(),
      width=11, height=8.5)
```

### ATT
```{r plot_att}
plt <- plot_ate(results_dr, results_ipw, "ATT", ps.estimation=c("grf", "grf.ate"))

print(plt)
ggsave(paste0(fig.dir,Sys.Date(),"_large_data_16confounders_ipw_dr_att_", population,"patients.pdf"), plot = last_plot(),
      width=11, height=8.5)
```

### ATC
```{r plot_atc}
plt <- plot_ate(results_dr, results_ipw, "ATC", ps.estimation=c("grf", "grf.ate"))

print(plt)
ggsave(paste0(fig.dir,Sys.Date(),"_large_data_16confounders_ipw_dr_atc_", population,"patients.pdf"), plot = last_plot(),
      width=11, height=8.5)
```

### ATE_overlap
```{r plot_ato}
plt <- plot_ate(results_dr, results_ipw, "ATE_overlap", ps.estimation=c("grf", "grf.ate"))

print(plt)
ggsave(paste0(fig.dir,Sys.Date(),"_large_data_16confounders_ipw_dr_ato_", population,"patients.pdf"), plot = last_plot(),
      width=11, height=8.5)
```